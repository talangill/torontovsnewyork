<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Order of the Significant P</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080608;
  --surface: #110e14;
  --surface2: #1a1520;
  --border: #2e2438;
  --border-bright: #4a3860;
  --ember: #e8621a;
  --ember-dim: #7a2f08;
  --gold: #d4a820;
  --gold-dim: #6b5010;
  --gold-bright: #f5c842;
  --rune: #8b5cf6;
  --rune-bright: #a78bfa;
  --blood: #c0182c;
  --blood-dim: #5a0a14;
  --sage: #1a7a4a;
  --sage-bright: #2dd474;
  --text: #e8ddd0;
  --text-dim: #9b8fa0;
  --text-muted: #5a4f60;
  --hp-full: #2dd474;
  --hp-mid: #f5c842;
  --hp-low: #e8621a;
  --hp-crit: #c0182c;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  min-height: 100vh;
  font-family: 'Crimson Pro', serif;
  color: var(--text);
  overflow-x: hidden;
  cursor: default;
}

#bg-layer {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 40% at 50% 0%, rgba(139,92,246,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 40% 60% at 0% 100%, rgba(232,98,26,0.05) 0%, transparent 60%),
    radial-gradient(ellipse 30% 50% at 100% 50%, rgba(212,168,32,0.04) 0%, transparent 60%);
}

.ember-particle {
  position: fixed; pointer-events: none; z-index: 0;
  width: 2px; height: 2px; border-radius: 50%;
  background: var(--ember);
  animation: rise linear infinite;
  opacity: 0;
}
@keyframes rise {
  0% { transform: translateY(100vh) translateX(0); opacity: 0; }
  10% { opacity: 0.8; }
  90% { opacity: 0.3; }
  100% { transform: translateY(-20px) translateX(var(--drift)); opacity: 0; }
}

#app {
  position: relative; z-index: 1;
  max-width: 820px;
  margin: 0 auto;
  padding: 20px 16px 60px;
}

#hud {
  display: none;
  position: sticky; top: 0; z-index: 100;
  background: rgba(8,6,8,0.92);
  border-bottom: 1px solid var(--border-bright);
  backdrop-filter: blur(12px);
  padding: 10px 16px;
  margin: 0 -16px 24px;
  gap: 16px;
  align-items: center;
  flex-wrap: wrap;
}
#hud.visible { display: flex; }

.hud-class {
  font-family: 'Cinzel', serif;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  color: var(--rune-bright);
  text-transform: uppercase;
  white-space: nowrap;
}
.hud-class span { color: var(--text-dim); }

.hp-block { flex: 1; min-width: 140px; }
.hp-label {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 4px;
  display: flex; justify-content: space-between;
}
.hp-label span { color: var(--text); font-size: 0.75rem; }
.hp-track {
  height: 8px; background: var(--surface2);
  border-radius: 4px; overflow: hidden;
  border: 1px solid var(--border);
}
.hp-fill {
  height: 100%; border-radius: 4px;
  background: var(--hp-full);
  transition: width 0.4s ease, background 0.4s ease;
  position: relative;
}
.hp-fill::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 60%, rgba(255,255,255,0.15));
  border-radius: 4px;
}

.xp-block { flex: 1; min-width: 140px; }
.xp-label {
  font-family: 'Cinzel', serif;
  font-size: 0.6rem; letter-spacing: 0.1em;
  color: var(--text-muted); text-transform: uppercase;
  margin-bottom: 4px;
  display: flex; justify-content: space-between;
}
.xp-label span { color: var(--gold); font-size: 0.75rem; }
.xp-track {
  height: 8px; background: var(--surface2);
  border-radius: 4px; overflow: hidden; border: 1px solid var(--border);
}
.xp-fill {
  height: 100%; border-radius: 4px;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold));
  transition: width 0.5s ease;
}

.hud-quest {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  letter-spacing: 0.08em; color: var(--gold-bright);
  text-transform: uppercase; white-space: nowrap;
}

#title-screen {
  text-align: center;
  padding: 40px 0 20px;
  animation: fadeUp 1.2s ease;
}

.title-sigil {
  font-size: 5rem; line-height: 1;
  margin-bottom: 1rem;
  animation: pulseGlow 3s ease-in-out infinite;
  display: block;
}
@keyframes pulseGlow {
  0%,100% { filter: drop-shadow(0 0 10px rgba(139,92,246,0.4)) drop-shadow(0 0 30px rgba(232,98,26,0.2)); }
  50% { filter: drop-shadow(0 0 20px rgba(139,92,246,0.7)) drop-shadow(0 0 50px rgba(232,98,26,0.4)); }
}

h1.game-title {
  font-family: 'Cinzel Decorative', serif;
  font-size: clamp(1.6rem, 5vw, 2.8rem);
  font-weight: 900;
  color: transparent;
  background: linear-gradient(135deg, var(--gold-bright) 0%, var(--ember) 50%, var(--rune-bright) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  line-height: 1.2;
  margin-bottom: 0.5rem;
  text-shadow: none;
  letter-spacing: 0.02em;
}

.title-sub {
  font-family: 'Cinzel', serif;
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  color: var(--text-dim);
  letter-spacing: 0.3em;
  text-transform: uppercase;
  margin-bottom: 2.5rem;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 2rem;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(139,92,246,0.04) 0%, transparent 50%, rgba(212,168,32,0.03) 100%);
  pointer-events: none;
}

.card-rune-tl, .card-rune-br {
  position: absolute;
  font-size: 1rem; opacity: 0.2; color: var(--rune);
}
.card-rune-tl { top: 10px; left: 14px; }
.card-rune-br { bottom: 10px; right: 14px; }

.class-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 1.5rem;
}
@media(max-width:520px){ .class-grid { grid-template-columns: 1fr; } }

.class-card {
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 1.4rem 1rem;
  cursor: pointer;
  text-align: center;
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}
.class-card::after {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 0%, var(--class-color, rgba(139,92,246,0.15)) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.3s;
}
.class-card:hover { border-color: var(--class-color, var(--rune)); transform: translateY(-4px); }
.class-card:hover::after { opacity: 1; }

.class-icon { font-size: 2.4rem; display: block; margin-bottom: 0.6rem; }
.class-name {
  font-family: 'Cinzel', serif;
  font-size: 0.85rem; font-weight: 700;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--gold-bright);
  margin-bottom: 0.4rem;
}
.class-perk {
  font-size: 0.82rem; color: var(--text-dim);
  font-style: italic; line-height: 1.5;
}
.class-hp {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  color: var(--hp-full); margin-top: 0.5rem;
  letter-spacing: 0.08em;
}

.scene-wrap { animation: fadeUp 0.4s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(18px); }
  to { opacity: 1; transform: translateY(0); }
}

.scene-header {
  display: flex; align-items: flex-start; gap: 14px;
  margin-bottom: 1.5rem;
  padding-bottom: 1.2rem;
  border-bottom: 1px solid var(--border-bright);
}
.scene-icon-lg { font-size: 2.8rem; flex-shrink: 0; line-height: 1; }
.scene-chapter {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--ember); margin-bottom: 0.3rem;
}
.scene-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(1.1rem, 3vw, 1.5rem);
  font-weight: 700; color: var(--gold-bright);
  line-height: 1.2;
}

.narrative {
  font-size: clamp(0.95rem, 2vw, 1.08rem);
  line-height: 1.9; color: var(--text);
  margin-bottom: 1.4rem;
}
.narrative p { margin-bottom: 0.9rem; }
.narrative p:last-child { margin-bottom: 0; }
.narrative em { color: var(--gold); font-style: italic; }
.narrative strong { color: var(--gold-bright); font-style: normal; }

.npc-speech {
  border-left: 3px solid var(--rune);
  padding: 0.7rem 1rem;
  margin: 0.8rem 0;
  background: rgba(139,92,246,0.06);
  border-radius: 0 4px 4px 0;
  font-style: italic;
  color: var(--rune-bright);
  font-size: 0.97rem;
}

.highlight { color: var(--ember); font-weight: 600; }
.term { color: var(--sage-bright); font-style: italic; font-weight: 600; }

.box {
  border-radius: 4px; padding: 1rem 1.2rem;
  margin: 1.2rem 0; font-size: 0.9rem;
  line-height: 1.75; position: relative;
}
.box-title {
  font-family: 'Cinzel', serif; font-size: 0.68rem;
  letter-spacing: 0.12em; text-transform: uppercase;
  margin-bottom: 0.5rem; display: block;
}
.box-lore {
  background: rgba(139,92,246,0.07);
  border: 1px solid rgba(139,92,246,0.25);
  border-left: 3px solid var(--rune);
  color: var(--text);
}
.box-lore .box-title { color: var(--rune-bright); }

.box-danger {
  background: rgba(192,24,44,0.08);
  border: 1px solid rgba(192,24,44,0.3);
  border-left: 3px solid var(--blood);
  color: var(--text);
}
.box-danger .box-title { color: var(--blood); }

.box-victory {
  background: rgba(45,212,116,0.07);
  border: 1px solid rgba(45,212,116,0.25);
  border-left: 3px solid var(--sage-bright);
  color: var(--text);
}
.box-victory .box-title { color: var(--sage-bright); }

.box-gold {
  background: rgba(212,168,32,0.08);
  border: 1px solid rgba(212,168,32,0.3);
  border-left: 3px solid var(--gold);
  color: var(--text);
}
.box-gold .box-title { color: var(--gold-bright); }

.hint-box {
  background: rgba(139,92,246,0.12);
  border: 1px dashed var(--rune);
  border-radius: 4px;
  padding: 0.8rem 1rem;
  margin: 1rem 0;
  font-size: 0.85rem;
  color: var(--rune-bright);
  display: none;
}
.hint-box.show { display: block; }
.hint-box .hint-label {
  font-family: 'Cinzel', serif; font-size: 0.62rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--rune); margin-bottom: 0.3rem; display: block;
}

.data-table {
  width: 100%; border-collapse: collapse;
  margin: 1rem 0; font-size: 0.87rem;
}
.data-table th {
  background: rgba(139,92,246,0.15);
  color: var(--rune-bright);
  font-family: 'Cinzel', serif; font-size: 0.68rem;
  letter-spacing: 0.08em; padding: 0.5rem 0.8rem;
  text-align: left; border-bottom: 1px solid var(--rune);
}
.data-table td {
  border: 1px solid var(--border);
  padding: 0.4rem 0.8rem;
  color: var(--text);
}
.data-table tr:nth-child(even) td { background: rgba(255,255,255,0.02); }

.choices-wrap { margin-top: 1.5rem; }
.choices-label {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--text-muted); margin-bottom: 0.8rem;
}
.choices { display: flex; flex-direction: column; gap: 8px; }

.choice-btn {
  background: var(--surface2);
  border: 1px solid var(--border-bright);
  border-radius: 4px;
  padding: 0.9rem 1.1rem 0.9rem 2.8rem;
  font-family: 'Crimson Pro', serif;
  font-size: clamp(0.9rem, 2vw, 1.02rem);
  color: var(--text); cursor: pointer;
  text-align: left; transition: all 0.2s ease;
  position: relative; line-height: 1.55;
}
.choice-btn::before {
  content: 'â—†';
  position: absolute; left: 1rem; top: 50%;
  transform: translateY(-50%);
  color: var(--border-bright);
  font-size: 0.6rem;
  transition: all 0.2s;
}
.choice-btn:hover {
  background: rgba(139,92,246,0.1);
  border-color: var(--rune);
  color: var(--gold-bright);
  transform: translateX(4px);
}
.choice-btn:hover::before { color: var(--rune-bright); transform: translateY(-50%) scale(1.4); }
.choice-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

#boss-screen { display: none; }
#boss-screen.active { display: block; }

.boss-arena {
  border: 2px solid var(--blood);
  border-radius: 8px;
  overflow: hidden;
  background: radial-gradient(ellipse at 50% 0%, rgba(192,24,44,0.12) 0%, transparent 60%);
  position: relative;
}

.boss-header {
  background: linear-gradient(90deg, var(--blood-dim), rgba(90,10,20,0.4));
  padding: 1rem 1.5rem;
  display: flex; align-items: center; gap: 12px;
  border-bottom: 1px solid var(--blood);
}
.boss-icon { font-size: 2.5rem; animation: bossFloat 2s ease-in-out infinite; }
@keyframes bossFloat {
  0%,100%{ transform: translateY(0) rotate(-2deg); }
  50%{ transform: translateY(-6px) rotate(2deg); }
}
.boss-name {
  font-family: 'Cinzel', serif; font-size: clamp(1rem, 3vw, 1.3rem);
  font-weight: 700; color: var(--blood);
  text-shadow: 0 0 20px rgba(192,24,44,0.5);
}
.boss-sub { font-size: 0.82rem; color: var(--text-dim); font-style: italic; margin-top: 0.2rem; }

.boss-hp-block { margin-left: auto; text-align: right; min-width: 120px; }
.boss-hp-label {
  font-family: 'Cinzel', serif; font-size: 0.6rem;
  letter-spacing: 0.1em; color: var(--blood); text-transform: uppercase;
  margin-bottom: 3px;
}
.boss-hp-track {
  height: 10px; background: rgba(0,0,0,0.5);
  border-radius: 5px; overflow: hidden;
  border: 1px solid var(--blood-dim);
}
.boss-hp-fill {
  height: 100%; border-radius: 5px;
  background: linear-gradient(90deg, var(--blood-dim), var(--blood));
  transition: width 0.5s ease;
  box-shadow: 0 0 8px rgba(192,24,44,0.5);
}

.boss-timer-wrap {
  display: flex; align-items: center; justify-content: center;
  gap: 12px; padding: 0.8rem 1.5rem;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid var(--border);
}
.boss-timer {
  font-family: 'Cinzel', serif; font-size: 1.8rem;
  font-weight: 700; color: var(--gold-bright);
  min-width: 3ch; text-align: center;
  transition: color 0.3s;
}
.boss-timer.urgent { color: var(--blood); animation: timerPulse 0.5s ease-in-out infinite; }
@keyframes timerPulse { 0%,100%{ opacity: 1; } 50%{ opacity: 0.5; } }
.timer-label {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  color: var(--text-muted); letter-spacing: 0.1em;
  text-transform: uppercase;
}

.boss-body { padding: 1.5rem; }

.phase-indicator {
  display: flex; gap: 6px; margin-bottom: 1.2rem;
  align-items: center;
}
.phase-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--border-bright);
  transition: all 0.3s;
}
.phase-dot.done { background: var(--sage-bright); box-shadow: 0 0 6px rgba(45,212,116,0.5); }
.phase-dot.active {
  background: var(--ember);
  box-shadow: 0 0 8px rgba(232,98,26,0.7);
  animation: phasePulse 1s ease-in-out infinite;
}
@keyframes phasePulse { 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.4); } }
.phase-label {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  color: var(--ember); letter-spacing: 0.1em;
  text-transform: uppercase; margin-left: 4px;
}

.boss-narrative {
  font-size: clamp(0.92rem, 2vw, 1.05rem);
  line-height: 1.85; color: var(--text);
  margin-bottom: 1.2rem;
}
.boss-narrative p { margin-bottom: 0.8rem; }

.boss-choices { display: flex; flex-direction: column; gap: 8px; }
.boss-choice {
  background: rgba(192,24,44,0.06);
  border: 1px solid var(--blood-dim);
  border-radius: 4px;
  padding: 0.85rem 1rem 0.85rem 2.6rem;
  font-family: 'Crimson Pro', serif;
  font-size: clamp(0.88rem, 2vw, 1rem);
  color: var(--text); cursor: pointer;
  text-align: left; transition: all 0.2s;
  position: relative; line-height: 1.5;
}
.boss-choice::before {
  content: 'âš”';
  position: absolute; left: 0.8rem; top: 50%;
  transform: translateY(-50%);
  font-size: 0.75rem; color: var(--blood-dim);
  transition: all 0.2s;
}
.boss-choice:hover {
  background: rgba(192,24,44,0.15);
  border-color: var(--blood);
  color: var(--gold-bright);
  transform: translateX(3px);
}
.boss-choice:hover::before { color: var(--blood); }
.boss-choice:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

.attack-flash {
  position: fixed; inset: 0; z-index: 999;
  pointer-events: none; opacity: 0;
  background: var(--flash-color, rgba(192,24,44,0.4));
  animation: flashAnim 0.5s ease forwards;
}
@keyframes flashAnim {
  0%{ opacity: 0.6; }
  100%{ opacity: 0; }
}

@keyframes shake {
  0%,100%{ transform: translateX(0); }
  20%{ transform: translateX(-8px); }
  40%{ transform: translateX(8px); }
  60%{ transform: translateX(-5px); }
  80%{ transform: translateX(5px); }
}
.shake { animation: shake 0.4s ease; }

.quest-map {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px; margin-top: 1.2rem;
}
@media(max-width:480px){ .quest-map { grid-template-columns: 1fr; } }

.quest-node {
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 6px; padding: 1.2rem;
  cursor: pointer; text-align: center;
  transition: all 0.25s ease; position: relative;
  overflow: hidden;
}
.quest-node::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 0%, var(--node-color, rgba(139,92,246,0.12)) 0%, transparent 70%);
  opacity: 0; transition: opacity 0.3s;
}
.quest-node:hover:not(.locked) { border-color: var(--gold); transform: translateY(-3px); }
.quest-node:hover:not(.locked)::before { opacity: 1; }
.quest-node.locked { opacity: 0.4; cursor: not-allowed; }
.quest-node.completed { border-color: var(--sage); }
.quest-node.completed::after {
  content: 'âœ“';
  position: absolute; top: 8px; right: 10px;
  color: var(--sage-bright); font-size: 1rem;
}

.node-icon { font-size: 2rem; display: block; margin-bottom: 0.5rem; }
.node-chapter {
  font-family: 'Cinzel', serif; font-size: 0.6rem;
  letter-spacing: 0.12em; color: var(--text-muted);
  text-transform: uppercase; margin-bottom: 0.3rem;
}
.node-name {
  font-family: 'Cinzel', serif; font-size: 0.82rem;
  color: var(--gold-bright); font-weight: 700;
  margin-bottom: 0.25rem;
}
.node-desc { font-size: 0.82rem; color: var(--text-dim); font-style: italic; }
.node-level {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  color: var(--rune-bright); margin-top: 0.5rem;
  letter-spacing: 0.08em;
}

.death-screen {
  text-align: center; padding: 2rem 1rem;
}
.death-icon { font-size: 4rem; display: block; margin-bottom: 1rem; animation: deathSpin 3s linear infinite; }
@keyframes deathSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
.death-title {
  font-family: 'Cinzel Decorative', serif;
  font-size: clamp(1.4rem, 4vw, 2rem);
  color: var(--blood);
  text-shadow: 0 0 30px rgba(192,24,44,0.6);
  margin-bottom: 0.5rem;
}
.death-sub {
  font-family: 'Cinzel', serif; font-size: 0.8rem;
  letter-spacing: 0.15em; color: var(--text-dim);
  text-transform: uppercase; margin-bottom: 1.5rem;
}

.levelup-screen {
  text-align: center; padding: 2rem 1rem;
  animation: levelUpAnim 0.6s ease;
}
@keyframes levelUpAnim {
  0%{ transform: scale(0.8); opacity: 0; }
  60%{ transform: scale(1.05); }
  100%{ transform: scale(1); opacity: 1; }
}
.levelup-icon { font-size: 4rem; display: block; margin-bottom: 0.8rem; }
.levelup-title {
  font-family: 'Cinzel Decorative', serif;
  font-size: clamp(1.3rem, 4vw, 2rem);
  color: var(--gold-bright);
  text-shadow: 0 0 30px rgba(212,168,32,0.6);
  margin-bottom: 0.5rem;
}

.btn {
  font-family: 'Cinzel', serif;
  font-size: 0.78rem; letter-spacing: 0.1em;
  text-transform: uppercase; padding: 0.7rem 1.6rem;
  border-radius: 4px; cursor: pointer;
  transition: all 0.2s ease; border: none;
  display: inline-block;
}
.btn-primary {
  background: linear-gradient(135deg, var(--ember-dim), var(--ember));
  color: var(--text);
  box-shadow: 0 4px 15px rgba(232,98,26,0.3);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(232,98,26,0.5);
}
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border-bright);
  color: var(--text-dim);
}
.btn-ghost:hover { border-color: var(--gold); color: var(--gold); }
.btn-gold {
  background: linear-gradient(135deg, var(--gold-dim), var(--gold));
  color: var(--bg);
}
.btn-gold:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,168,32,0.4); }

.rune-divider {
  text-align: center; color: var(--rune);
  opacity: 0.3; letter-spacing: 0.5em;
  font-size: 0.8rem; margin: 1.5rem 0;
}

.quest-complete-banner {
  text-align: center; padding: 1.5rem;
  background: radial-gradient(ellipse at 50% 0%, rgba(45,212,116,0.1) 0%, transparent 70%);
  border: 1px solid var(--sage);
  border-radius: 6px; margin-bottom: 1rem;
}
.quest-complete-banner .qc-icon { font-size: 3rem; display: block; margin-bottom: 0.5rem; }
.quest-complete-banner .qc-title {
  font-family: 'Cinzel', serif; font-size: clamp(1rem, 3vw, 1.3rem);
  color: var(--sage-bright); margin-bottom: 0.3rem;
}
.quest-complete-banner .qc-xp {
  font-family: 'Cinzel', serif; font-size: 0.8rem;
  color: var(--gold); letter-spacing: 0.1em;
}

.scroll-item {
  opacity: 0; transform: translateY(12px);
  animation: scrollReveal 0.4s ease forwards;
}
@keyframes scrollReveal {
  to { opacity: 1; transform: translateY(0); }
}

.dmg-number {
  position: fixed;
  font-family: 'Cinzel', serif; font-size: 1.8rem;
  font-weight: 700; pointer-events: none; z-index: 1000;
  animation: dmgFloat 1.2s ease forwards;
}
@keyframes dmgFloat {
  0%{ transform: translateY(0); opacity: 1; }
  100%{ transform: translateY(-70px); opacity: 0; }
}

@media(max-width:600px){
  .card { padding: 1.2rem; }
  .boss-body { padding: 1rem; }
}
</style>
</head>
<body>
<div id="bg-layer"></div>
<div id="app">
  <div id="hud">
    <div class="hud-class">âš” <span id="hud-class-name">â€”</span></div>
    <div class="hp-block">
      <div class="hp-label">HP <span id="hud-hp-text">â€”</span></div>
      <div class="hp-track"><div class="hp-fill" id="hud-hp-fill" style="width:100%"></div></div>
    </div>
    <div class="xp-block">
      <div class="xp-label">XP <span id="hud-xp-text">â€”</span></div>
      <div class="xp-track"><div class="xp-fill" id="hud-xp-fill" style="width:0%"></div></div>
    </div>
    <div class="hud-quest" id="hud-quest">â€”</div>
  </div>
  <div id="main-content"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = {
  class: null,
  hp: 0, maxHp: 0,
  xp: 0, level: 1,
  questsDone: [],
  currentQuest: null,
  currentScene: null,
  bossTimer: null,
};

// FIX 1: Use a global callback reference instead of serializing to string
let pendingLevelUpCallback = null;

const XP_PER_LEVEL = 100;

// Quest order for sequential unlock logic
const QUEST_ORDER = ['q1','q2','q3','q4'];

const CLASSES = {
  wizard: {
    name: 'Head of Revenue',
    icon: 'ğŸ“Š',
    desc: 'You live in spreadsheets. Hints reveal test formulae and numerical logic.',
    hp: 80,
    color: 'rgba(139,92,246,0.2)',
    hintType: 'formula',
    hintLabel: 'ğŸ“Š Revenue Office Hint'
  },
  healer: {
    name: 'Quality & Standards Manager',
    icon: 'ğŸŒ¿',
    desc: 'Meticulous about process. Hints focus on assumption checks before any test.',
    hp: 100,
    color: 'rgba(45,212,116,0.2)',
    hintType: 'assumption',
    hintLabel: 'ğŸŒ¿ Standards Office Hint'
  },
  rogue: {
    name: 'Guest Experience Director',
    icon: 'ğŸ—ï¸',
    desc: 'Sharp instincts, guest-first thinking. Hints guide interpretation of results.',
    hp: 70,
    color: 'rgba(232,98,26,0.2)',
    hintType: 'interpretation',
    hintLabel: 'ğŸ—ï¸ Guest Insight Hint'
  }
};

const QUESTS = {
  q1: {
    id: 'q1', name: "The Innkeeper's Ledger", icon: 'ğŸ¨',
    chapter: 'Chapter I', topic: 'Correlation',
    bossName: 'The Ghost of Spurious Reviews',
    bossIcon: 'ğŸ‘ï¸',
    bossSub: "It sees patterns in the guest book that aren't there",
    scenes: ['q1_intro','q1_plot','q1_linearity','q1_pearson','q1_interpret'],
    boss: 'boss_q1'
  },
  q2: {
    id: 'q2', name: "The Banquet Hall Dispute", icon: 'ğŸ½ï¸',
    chapter: 'Chapter II', topic: 'Chi-Square',
    bossName: 'The Wraith of the Contingency Table',
    bossIcon: 'ğŸ‘»',
    bossSub: 'It haunts the booking records with false associations',
    scenes: ['q2_intro','q2_expected','q2_assumption','q2_result'],
    boss: 'boss_q2'
  },
  q3: {
    id: 'q3', name: "The Three Trials of the Sommelier", icon: 'ğŸ·',
    chapter: 'Chapter III', topic: 'T-Tests',
    bossName: 'The Variance Hydra of the Cellar',
    bossIcon: 'ğŸ‰',
    bossSub: 'Each head embodies a different t-test violation',
    scenes: ['q3_intro','q3_match','q3_levene','q3_tail'],
    boss: 'boss_q3'
  },
  q4: {
    id: 'q4', name: "The Grand Hotel Ratings War", icon: 'ğŸ°',
    chapter: 'Chapter IV', topic: 'ANOVA',
    bossName: 'The Omnibus Concierge',
    bossIcon: 'ğŸ—¿',
    bossSub: 'It claims one grand result tells you everything',
    scenes: ['q4_intro','q4_anova','q4_welch','q4_posthoc'],
    boss: 'boss_q4'
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUEST UNLOCK LOGIC (FIX 2)
// A quest is unlocked if:
//   - it's quest 1 (always available), OR
//   - the previous quest in QUEST_ORDER has been completed
// This replaces the brittle XP-level gate that could fail
// if a player took damage and missed XP pickups.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isQuestLocked(questId) {
  const idx = QUEST_ORDER.indexOf(questId);
  if (idx === 0) return false; // Quest 1 always available
  const prevQuestId = QUEST_ORDER[idx - 1];
  return !G.questsDone.includes(prevQuestId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCENES = {

  q1_intro: {
    icon: 'ğŸ¨', chapter: 'Quest I Â· Correlation',
    title: "The Innkeeper's Ledger",
    narrative: `<p>You are the newly appointed Revenue Manager at <em>The Crowned Stag</em>, the most celebrated inn in the realm. The head innkeeper, Margaux, drops a thick ledger on your desk.</p>
    <p class="npc-speech">"Twenty seasons of records â€” nightly room rates (gold coins) and occupancy rates (%). My predecessor swore that charging more fills the inn. The owner insists lower prices are the key. I need to know: is there a real relationship between our price and how full we are?"</p>
    <p>Your deputy leans over: <em>"Just look at the numbers. You've been in hospitality long enough to have a feeling for this."</em></p>
    <p>You pause. A feeling. Is that really how a data-driven manager operates?</p>`,
    hints: {
      formula: "Pearson's r measures linear association. But you can't apply it without first examining the shape of the relationship.",
      assumption: 'Before any test, you must verify the data meets the test\'s assumptions. For correlation, linearity is the critical check.',
      interpretation: 'A result means nothing if you chose the wrong test. Check the data structure visually first.'
    },
    choices: [
      { text: "Trust your instincts â€” you've worked in hospitality for years. Give Margaux your gut feeling and move on.", next: 'q1_bad_guess', damage: 20, bad: true },
      { text: "Plot the data first. Draw a scatter plot of room rate vs occupancy before deciding on any statistical test.", next: 'q1_plot', xp: 10 }
    ]
  },

  q1_bad_guess: {
    icon: 'ğŸ’€', chapter: 'Quest I Â· Setback',
    title: 'The Reputation Crumbles',
    narrative: `<p>You declare confidently that higher prices hurt occupancy. Margaux slashes rates by 30%. Occupancy barely budges â€” but revenue collapses. The owner demands an explanation.</p>
    <div class="box box-danger"><span class="box-title">âš” The Monster Strikes! âˆ’20 HP</span>
    Human intuition is dangerously unreliable with numerical data. We see what we expect to see. A scatter plot takes two minutes and could have saved the inn's entire season. <strong>Never skip the visual inspection</strong> â€” it is your first line of defence against costly decisions.</div>
    <p>Bruised but wiser, you return to the ledger.</p>`,
    choices: [{ text: 'â†© Return to the ledger room', next: 'q1_intro' }]
  },

  q1_plot: {
    icon: 'ğŸ“Š', chapter: 'Quest I Â· Correlation',
    title: 'The Scatter Plot Speaks',
    narrative: `<p>You spread the 20 seasons of data across the table and draw two scatter plots. Rate vs occupancy forms a gentle downward slope â€” almost a straight line. But you also plot average daily temperature vs occupancy: it curves upward steeply in summer, plateaus, then drops in winter.</p>
    <p class="npc-speech">Margaux studies the temperature plot: "Interesting curve. Does that matter for which test we use?"</p>
    <div class="box box-lore"><span class="box-title">ğŸ“œ The Law of Linearity</span>
    Pearson's r quantifies <strong>linear</strong> association only â€” it measures how closely two variables follow a straight line. A curved relationship can have r â‰ˆ 0 while being a strong, real relationship. You must confirm the scatter looks roughly linear before computing r.</div>`,
    hints: {
      formula: "Pearson's r = Î£[(xi - xÌ„)(yi - È³)] / [(n-1)Â·sxÂ·sy]. This formula literally captures linear co-variation.",
      assumption: "Pearson's r requires: (1) linearity, (2) both variables continuous, (3) no extreme outliers skewing the picture.",
      interpretation: "A non-significant Pearson r on a curved dataset doesn't mean 'no relationship' â€” it means the wrong test was applied."
    },
    choices: [
      { text: "The temperature-occupancy curve isn't suitable for Pearson's r. But rate-occupancy looks linear â€” I'll run Pearson's r on that relationship.", next: 'q1_linearity', xp: 15 },
      { text: "The curves are minor â€” Pearson's r is robust enough for both plots. Run it on all relationships at once.", next: 'q1_bad_curve', damage: 20, bad: true }
    ]
  },

  q1_bad_curve: {
    icon: 'ğŸ’€', chapter: 'Quest I Â· Setback',
    title: 'The Curved Dagger',
    narrative: `<p>You apply Pearson's r to temperature vs occupancy and get r = 0.38, p = 0.10. You report no significant relationship with temperature. But Spearman's rank correlation returns rs = 0.67, p = 0.001. Temperature clearly matters â€” you just used the wrong tool.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>Pearson's r on a curved relationship systematically underestimates the true association. Always match the test to the <em>shape</em> of the data you see in the scatter plot. Curved pattern â†’ Spearman. Straight pattern â†’ Pearson.</div>`,
    choices: [{ text: 'â†© Return and inspect more carefully', next: 'q1_plot' }]
  },

  q1_linearity: {
    icon: 'âš–ï¸', chapter: 'Quest I Â· Correlation',
    title: 'The Test Is Run',
    narrative: `<p>You run Pearson's correlation on room rate vs occupancy across the 20 seasons. The results arrive by courier:</p>
    <div class="box box-gold"><span class="box-title">ğŸ“Š Results Scroll</span><strong>r = âˆ’0.74, p = 0.0002, 95% CI [âˆ’0.89, âˆ’0.47]</strong><br>n = 20 seasons</div>
    <p>Margaux studies it eagerly: <em>"Wonderful! r is negative and p is tiny. Lower prices cause higher occupancy â€” let's cut rates immediately!"</em></p>`,
    hints: {
      formula: 'rÂ² = 0.55 â€” about 55% of occupancy variance is linearly associated with rate variation across seasons.',
      assumption: 'The CI [âˆ’0.89, âˆ’0.47] excludes zero â€” additional evidence the relationship is real, not just a fluke.',
      interpretation: 'p = 0.0002 answers: "If the true correlation were zero, how likely is seeing r = âˆ’0.74 with n=20?" Very unlikely. But that says nothing about causation.'
    },
    choices: [
      { text: "r = âˆ’0.74 is a strong negative correlation. p < 0.05 confirms it. Lower prices cause higher occupancy â€” cut rates.", next: 'q1_bad_causation', damage: 25, bad: true },
      { text: "r = âˆ’0.74 shows a strong negative linear association â€” statistically significant. But correlation cannot establish causation. Both could reflect seasonal patterns: low season brings lower prices AND lower demand regardless.", next: 'q1_pearson', xp: 20 }
    ]
  },

  q1_bad_causation: {
    icon: 'ğŸ’€', chapter: 'Quest I Â· Setback',
    title: 'The Revenue Disaster',
    narrative: `<p>Margaux cuts rates by 25%. Occupancy rises slightly â€” but RevPAR plummets. The real driver? Seasons: off-peak months always had both low rates AND low demand. The correlation was driven by a confound â€” season â€” not a causal price-demand mechanism.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’25 HP</span><strong>Correlation â‰  Causation.</strong> An r-value, however strong, cannot establish that changing X will change Y. Both could be driven by a third variable (here: season). Causality requires controlled experimentation.</div>`,
    choices: [{ text: 'â†© Revisit the results before advising', next: 'q1_linearity' }]
  },

  q1_pearson: {
    icon: 'ğŸ¯', chapter: 'Quest I Â· Correlation',
    title: 'The Ghost in the Guest Book',
    narrative: `<p>Margaux nods, impressed. <em>"Well analysed. But I warn you â€” something else lurks in these records. The Ghost of Spurious Reviews has been haunting the inn's data, manufacturing false correlations to mislead our managers. Every revenue director who faces it alone has made a disastrous pricing decision."</em></p>
    <p>The spectral threat waits in the ledger room at midnight. Your HP is what remains. Your analytical rigour is your only weapon.</p>
    <div class="box box-lore"><span class="box-title">âš” Boss Battle Approaching</span>The Ghost presents raw hospitality data. You must: identify the correct test â†’ check the linearity assumption â†’ interpret the output correctly. The clock ticks. Wrong calls cost HP.</div>`,
    choices: [{ text: 'âš” Enter the ledger room at midnight', next: 'BOSS_q1', boss: true }]
  },

  q2_intro: {
    icon: 'ğŸ½ï¸', chapter: 'Quest II Â· Chi-Square',
    title: "The Banquet Hall Dispute",
    narrative: `<p>The Grand Banquet Hall hosts two types of events: <em>Corporate Conferences</em> and <em>Wedding Receptions</em>. The Events Manager, Lord Pembridge, is furious.</p>
    <p class="npc-speech">"Our guests leave feedback choosing one of three verdicts: Excellent, Satisfactory, or Poor. I think corporate clients are harder to please. My deputy thinks weddings generate more complaints. We need to know: is there an association between <strong>event type</strong> and <strong>satisfaction verdict</strong>?"</p>
    <table class="data-table">
      <tr><th>Satisfaction</th><th>Corporate</th><th>Wedding</th><th>Row Total</th></tr>
      <tr><td>Excellent</td><td>52</td><td>38</td><td>90</td></tr>
      <tr><td>Satisfactory</td><td>31</td><td>44</td><td>75</td></tr>
      <tr><td>Poor</td><td>17</td><td>18</td><td>35</td></tr>
      <tr><td><strong>Column Total</strong></td><td><strong>100</strong></td><td><strong>100</strong></td><td><strong>200</strong></td></tr>
    </table>
    <p>Both variables are <span class="term">categorical</span>: event type and satisfaction rating. No continuous measurements. Just counts.</p>`,
    hints: {
      formula: 'The test statistic is Ï‡Â² = Î£ (O-E)Â²/E. But first you need to know what E (the expected count) represents.',
      assumption: 'Chi-Square requires all expected cell counts â‰¥ 5. This must be verified before running the test.',
      interpretation: 'Chi-Square tests independence. Hâ‚€: satisfaction is unrelated to event type. Hâ‚: the two variables are associated.'
    },
    choices: [
      { text: "Corporate shows 52% Excellent vs 38% for weddings â€” clearly different. The pattern is obvious. Declare it a real association.", next: 'q2_bad_eyeball', damage: 20, bad: true },
      { text: "Calculate expected counts first â€” what the cells would look like if satisfaction were completely independent of event type â€” then compare to what we actually observed.", next: 'q2_expected', xp: 10 }
    ]
  },

  q2_bad_eyeball: {
    icon: 'ğŸ’€', chapter: 'Quest II Â· Setback',
    title: 'The Eyeball Mistake',
    narrative: `<p>You declare the association real. But with only 35 "Poor" responses, Lord Pembridge's deputy tears your analysis apart: <em>"Could those differences be pure chance? You have no idea how large the gap needs to be to be meaningful."</em></p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>Percentage differences alone are meaningless without knowing whether they exceed what random chance could produce. That is precisely what Chi-Square quantifies â€” and why it exists.</div>`,
    choices: [{ text: 'â†© Return to the booking records', next: 'q2_intro' }]
  },

  q2_expected: {
    icon: 'ğŸ”¢', chapter: 'Quest II Â· Chi-Square',
    title: 'Expected Counts & The Rule of Five',
    narrative: `<p>The formula for what we'd expect in each cell if there were <em>no</em> relationship:</p>
    <div class="box box-lore"><span class="box-title">ğŸ“ E = (Row Total Ã— Column Total) / Grand Total</span>
    Excellent Ã— Corporate: (90 Ã— 100) / 200 = <strong>45</strong><br>
    Excellent Ã— Wedding: (90 Ã— 100) / 200 = <strong>45</strong><br>
    Satisfactory Ã— Corporate: (75 Ã— 100) / 200 = <strong>37.5</strong><br>
    Satisfactory Ã— Wedding: (75 Ã— 100) / 200 = <strong>37.5</strong><br>
    Poor Ã— Corporate: (35 Ã— 100) / 200 = <strong>17.5</strong><br>
    Poor Ã— Wedding: (35 Ã— 100) / 200 = <strong>17.5</strong></div>
    <p>Lord Pembridge paces: <em>"Before we go further â€” what rule must we check to know Chi-Square is even valid here?"</em></p>`,
    hints: {
      formula: 'Ï‡Â² = Î£(O-E)Â²/E. The larger the discrepancy between observed and expected, the larger Ï‡Â².',
      assumption: "The key assumption: ALL expected cell frequencies must be â‰¥ 5. If violated, switch to Fisher's Exact Test.",
      interpretation: "Under Hâ‚€ (independence), expected counts describe what the table would look like. The larger the O-E gaps, the less plausible independence becomes."
    },
    choices: [
      { text: "Grand total is 200 â€” large enough to trust the approximation. Cell sizes only matter in tiny studies.", next: 'q2_bad_rule', damage: 20, bad: true },
      { text: "Every expected count must be â‰¥ 5. The smallest here is 17.5 â€” we're safely above the threshold. Chi-Square is valid.", next: 'q2_assumption', xp: 15 }
    ]
  },

  q2_bad_rule: {
    icon: 'ğŸ’€', chapter: 'Quest II Â· Setback',
    title: 'The Small Cell Trap',
    narrative: `<p>In the next study, some expected counts fall below 5. Your Chi-Square p-value is unreliable. The journal review board sends back your report as invalid.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>Chi-Square relies on a mathematical approximation that only holds when expected cell counts are sufficient (all â‰¥ 5). When this fails: use <strong>Fisher's Exact Test</strong>. Always check expected counts, not just observed ones.</div>`,
    choices: [{ text: 'â†© Return and check the cells properly', next: 'q2_expected' }]
  },

  q2_assumption: {
    icon: 'âœ…', chapter: 'Quest II Â· Chi-Square',
    title: 'The Test Delivers Its Verdict',
    narrative: `<p>All expected counts â‰¥ 5. You run Chi-Square on the banquet hall data. Results arrive:</p>
    <div class="box box-gold"><span class="box-title">ğŸ“Š Results Scroll</span><strong>Ï‡Â²(2) = 6.84, p = 0.033</strong></div>
    <p>Lord Pembridge slams the table triumphantly: <em>"p &lt; 0.05! So corporate clients specifically give fewer Poor ratings than weddings â€” that's what the test proves, yes?"</em></p>`,
    hints: {
      formula: 'df = (rows-1)(cols-1) = (3-1)(2-1) = 2. Critical Ï‡Â² at df=2, Î±=0.05 is 5.99. We got 6.84 â€” just beyond the threshold.',
      assumption: "Fisher's Exact Test was not needed (all E â‰¥ 5). But with a different, smaller dataset, you'd need to switch.",
      interpretation: 'Standardised residuals reveal which cells contribute most to the significant result. A residual with |z| > 2 flags that cell as notable.'
    },
    choices: [
      { text: "Yes â€” significant Chi-Square identifies which specific event type gets which specific satisfaction rating more often.", next: 'q2_bad_interpret', damage: 25, bad: true },
      { text: "No â€” Chi-Square is an omnibus test. It says the overall association is non-random, but not which cells drive it. We need standardised residuals or post-hoc comparisons to pinpoint that.", next: 'q2_result', xp: 20 }
    ]
  },

  q2_bad_interpret: {
    icon: 'ğŸ’€', chapter: 'Quest II Â· Setback',
    title: 'Overreaching the Verdict',
    narrative: `<p>You announce specific satisfaction-event pairs differ. An analyst points out the omnibus test makes no such claim â€” and your standardised residuals don't support the conclusion.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’25 HP</span>Chi-Square's significant result says: <em>"The distribution of satisfaction ratings is not the same across event types."</em> That's all. To know <em>which</em> cells are driving it, examine <strong>standardised residuals</strong> (|z| > 2) or run corrected pairwise comparisons.</div>`,
    choices: [{ text: 'â†© Return and interpret correctly', next: 'q2_assumption' }]
  },

  q2_result: {
    icon: 'ğŸ¯', chapter: 'Quest II Â· Chi-Square',
    title: 'Deeper in the Hall',
    narrative: `<p>Lord Pembridge is grudgingly impressed. He lowers his voice: <em>"There is a reason the banquet hall's old records are kept under lock and key. The Wraith of the Contingency Table haunts them â€” a spectre born from decades of misclassified event data. It has destroyed three event managers before you. Tonight, you must face it."</em></p>
    <div class="box box-lore"><span class="box-title">âš” Boss Battle Approaching</span>The Wraith will present new categorical hospitality data. You must identify the right test, verify assumptions, and correctly interpret the result â€” against the clock.</div>`,
    choices: [{ text: 'ğŸ‘» Enter the locked archive at midnight', next: 'BOSS_q2', boss: true }]
  },

  q3_intro: {
    icon: 'ğŸ·', chapter: 'Quest III Â· T-Tests',
    title: "Three Studies, One Cellar",
    narrative: `<p>The Royal Court has commissioned three separate wine studies. All land on your desk the same morning, each measuring a continuous variable with a comparison of means. But <em>the design of each is fundamentally different.</em></p>
    <p class="npc-speech"><strong>Study A:</strong> The same 30 sommeliers rated the house wine before and after a 4-week refinement programme. Same people, measured twice.</p>
    <p class="npc-speech"><strong>Study B:</strong> 25 new sommeliers tasted the wine. The Guild's benchmark for a quality wine is a score of 72. Does this wine meet the standard?</p>
    <p class="npc-speech"><strong>Study C:</strong> 30 sommeliers tasted the aged reserve; a completely separate group of 30 tasted the young vintage. Never the same person, never the same wine.</p>
    <p>An overconfident junior analyst declares: <em>"They're all t-tests â€” just run the same test on all three."</em></p>`,
    hints: {
      formula: 'Paired t: t = dÌ„/(sd/âˆšn). One-sample t: t = (xÌ„ - Î¼â‚€)/(s/âˆšn). Independent t: t = (xÌ„â‚ - xÌ„â‚‚)/SE. Each formula reflects a different study structure.',
      assumption: 'The critical question: are the observations independent? Paired data deliberately violates independence â€” and that\'s its strength.',
      interpretation: 'Using the wrong t-test can completely reverse your conclusions. The paired test is far more powerful when the same people are measured twice.'
    },
    choices: [
      { text: "The junior analyst has a point â€” they're all t-tests. Run a standard two-sample t-test on all three for consistency.", next: 'q3_bad_allsame', damage: 25, bad: true },
      { text: "The designs are completely different. Study A = paired t-test. Study B = one-sample t-test. Study C = independent samples t-test.", next: 'q3_match', xp: 15 }
    ]
  },

  q3_bad_allsame: {
    icon: 'ğŸ’€', chapter: 'Quest III Â· Setback',
    title: 'The Wrong Decanter',
    narrative: `<p>You run an independent t-test on Study A. By ignoring that the same 30 sommeliers were measured twice, you discard the within-person correlation. Your p = 0.18 â€” the refinement programme appears ineffective. The correct paired t-test gives p = 0.002. The programme works brilliantly â€” you nearly cancelled it.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’25 HP</span>The paired t-test uses each person's <strong>difference score</strong> (after minus before), removing the noise of individual baseline differences. Using an independent t-test on paired data ignores the most important information in your dataset.</div>`,
    choices: [{ text: 'â†© Return to the cellar', next: 'q3_intro' }]
  },

  q3_match: {
    icon: 'âš–ï¸', chapter: 'Quest III Â· T-Tests',
    title: "Levene's Challenge in the Cellar",
    narrative: `<p>Correct. For Study C (aged reserve vs young vintage, independent groups), you're about to run the t-test when the Master Sommelier grabs your arm.</p>
    <p class="npc-speech">"Before you compare those two means â€” how spread out are the scores within each group? Are the variances similar?"</p>
    <p>You run Levene's test for equality of variances:</p>
    <div class="box box-gold"><span class="box-title">ğŸ“Š Levene's Test Result</span><strong>F(1, 58) = 7.1, p = 0.010</strong></div>
    <p>Levene's Hâ‚€ is that both groups share equal variance. p = 0.010. What does this tell you â€” and which t-test do you now use?</p>`,
    hints: {
      formula: "Welch's t-test adjusts degrees of freedom downward to account for unequal variance.",
      assumption: "Levene's p = 0.010 < 0.05 â†’ reject Hâ‚€ of equal variances â†’ Student's t-test assumption violated â†’ Welch's required.",
      interpretation: "Many statisticians default to Welch's t-test always. It loses almost no power when variances are equal but offers strong protection when they're not."
    },
    choices: [
      { text: "p = 0.010 is marginal. Student's t-test is robust to slight variance differences â€” use the classic formula.", next: 'q3_bad_student', damage: 20, bad: true },
      { text: "p = 0.010 < 0.05: we reject equal variances. Student's assumption is violated. Use Welch's t-test, which estimates the variances separately and adjusts degrees of freedom.", next: 'q3_levene', xp: 20 }
    ]
  },

  q3_bad_student: {
    icon: 'ğŸ’€', chapter: 'Quest III Â· Setback',
    title: 'The Variance Ignored',
    narrative: `<p>Your report is rejected by the Guild's quality board: <em>"With Levene's p = 0.010, the equal variance assumption is violated. Student's t-test inflates the Type I error rate. Welch's t-test was required."</em></p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>Student's t-test pools the two group variances into one estimate â€” valid only when they're similar. Welch's t-test estimates them separately and adjusts degrees of freedom. The safer default in any independent-groups comparison is Welch's.</div>`,
    choices: [{ text: 'â†© Return and choose correctly', next: 'q3_match' }]
  },

  q3_levene: {
    icon: 'ğŸ¯', chapter: 'Quest III Â· T-Tests',
    title: 'The One-Tailed Temptation',
    narrative: `<p>Welch's t-test on Study C: <strong>t(51.3) = 2.6, p (two-tailed) = 0.012</strong>. The aged reserve scores significantly higher.</p>
    <p>The estate owner strides in: <em>"Excellent! But we always predicted the aged reserve would be superior â€” not just different. Shouldn't we use a one-tailed test? Our p would be 0.006 â€” an even stronger result to show the investors!"</em></p>`,
    hints: {
      formula: "One-tailed p = two-tailed p / 2 when testing in the direction the data went. That halving is exactly the problem â€” you're exploiting prior knowledge of the result.",
      assumption: 'One-tailed testing requires the directional hypothesis to be committed to BEFORE data collection â€” ideally pre-registered in writing.',
      interpretation: "p = 0.012 (two-tailed) is already convincing. The cosmetic gain of one-tailed testing isn't worth the integrity cost if direction was chosen after seeing results."
    },
    choices: [
      { text: "We clearly predicted aged would outscore young â€” use one-tailed for a stronger, more focused test.", next: 'q3_bad_onetail', damage: 25, bad: true },
      { text: "One-tailed is only legitimate if the directional hypothesis was pre-registered before data collection. Choosing it after seeing which direction the data went is p-hacking. Keep two-tailed.", next: 'q3_tail', xp: 20 }
    ]
  },

  q3_bad_onetail: {
    icon: 'ğŸ’€', chapter: 'Quest III Â· Setback',
    title: 'The Integrity Breach',
    narrative: `<p>The Guild's auditors discover you chose one-tailed after reviewing preliminary results. Your study is flagged for selective reporting. The estate's quality certification is suspended.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’25 HP</span>One-tailed testing is legitimate only with a <em>genuine a priori</em> directional hypothesis â€” stated and documented before any data is seen. "We thought aged wine would be better" post-hoc is not a hypothesis, it's a rationalisation. It silently doubles your false-positive rate in the chosen direction.</div>`,
    choices: [{ text: 'â†© Return and make the principled choice', next: 'q3_levene' }]
  },

  q3_tail: {
    icon: 'ğŸ‰', chapter: 'Quest III Â· T-Tests',
    title: 'The Hydra of the Deep Cellar',
    narrative: `<p>Three trials of the sommelier â€” complete. But deep in the oldest part of the cellar coils the <strong>Variance Hydra</strong>. Each of its three heads embodies a different t-test violation.</p>
    <div class="box box-lore"><span class="box-title">âš” Boss Battle Approaching</span>The Hydra will present a fresh hospitality scenario per head. You must choose the right t-test, check Levene's result, and navigate the one-tailed question â€” all under the clock.</div>`,
    choices: [{ text: 'ğŸ‰ Descend into the deep cellar', next: 'BOSS_q3', boss: true }]
  },

  q4_intro: {
    icon: 'ğŸ°', chapter: 'Quest IV Â· ANOVA',
    title: "The Grand Hotel Ratings War",
    narrative: `<p>The Royal Hospitality Council has received guest satisfaction scores (0â€“100) from <strong>five competing grand hotels</strong>: The Ivory Tower, The Velvet Crown, The Amber Keep, The Silver Spire, and The Golden Fleece. Each contributed 20 guests. The Council demands to know: are any hotels meaningfully different from the others?</p>
    <p>Your junior analyst spots an opportunity: <em>"Easy â€” run a t-test between every pair of hotels. That's only 10 comparisons!"</em></p>`,
    hints: {
      formula: 'ANOVA F = MS_between / MS_within â€” the ratio of between-group to within-group variance, tested simultaneously for all groups.',
      assumption: 'Family-wise error rate at Î±=0.05 across k=10 tests: FWER = 1-(0.95)^10 â‰ˆ 0.40. A 40% chance of at least one false alarm.',
      interpretation: "ANOVA's F-test controls Type I error at 0.05 for the entire family of comparisons in one single test."
    },
    choices: [
      { text: "Ten t-tests is the only way to see all pairwise differences â€” run them.", next: 'q4_bad_multtest', damage: 20, bad: true },
      { text: "Ten tests at Î± = 0.05 means a 40% chance of at least one spurious significant result. ANOVA tests all five hotels simultaneously, keeping the error rate at 5%.", next: 'q4_anova', xp: 15 }
    ]
  },

  q4_bad_multtest: {
    icon: 'ğŸ’€', chapter: 'Quest IV Â· Setback',
    title: 'The Multiple Comparisons Plague',
    narrative: `<p>You run 10 t-tests. Four come back "significant." You publish rankings. Three turn out to be false positives. The Ivory Tower threatens legal action.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>At Î± = 0.05, each t-test has a 5% false-positive rate. Run 10 and the family-wise error rate â‰ˆ 40%. ANOVA solves this: one F-test, all groups, Î± = 0.05 maintained. Then post-hoc tests identify specific differences.</div>`,
    choices: [{ text: 'â†© Return to the Council chamber', next: 'q4_intro' }]
  },

  q4_anova: {
    icon: 'ğŸ”¬', chapter: 'Quest IV Â· ANOVA',
    title: 'Fisher or Welch â€” The Variance Duel',
    narrative: `<p>Before running ANOVA, you check variance equality with Levene's test:</p>
    <div class="box box-gold"><span class="box-title">ğŸ“Š Levene's Test</span><strong>F(4, 95) = 3.8, p = 0.007</strong></div>
    <p>The Council's statistician raises a hand: <em>"The hotels show unequal variance in their satisfaction scores. Standard one-way ANOVA assumes equal variance. How do you proceed?"</em></p>`,
    hints: {
      formula: "Welch's ANOVA adjusts degrees of freedom per group, extending the Welch's t-test logic to k groups. It does not pool variances.",
      assumption: "Levene's p = 0.007 < 0.05 â†’ equal variance assumption violated â†’ Fisher's ANOVA not appropriate â†’ use Welch's ANOVA + Games-Howell post-hoc.",
      interpretation: "Fisher's ANOVA is more powerful when variances truly are equal. Welch's is the safer choice when Levene's is significant."
    },
    choices: [
      { text: "ANOVA is robust to mild variance differences â€” use standard Fisher's ANOVA. The sample sizes are similar enough.", next: 'q4_bad_fisher', damage: 20, bad: true },
      { text: "Levene's p = 0.007 < 0.05: equal variance assumption is violated. Use Welch's ANOVA, which adjusts for unequal variances across the five hotels.", next: 'q4_welch', xp: 20 }
    ]
  },

  q4_bad_fisher: {
    icon: 'ğŸ’€', chapter: 'Quest IV Â· Setback',
    title: "Fisher's False Comfort",
    narrative: `<p>Your analysis is challenged at the Council. A simulation shows Fisher's ANOVA inflated the Type I error rate to ~10% given the variance heterogeneity.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’20 HP</span>Fisher's ANOVA pools all group variances â€” valid only when Levene's is non-significant. The correct pairings: <strong>Levene's non-significant â†’ Fisher's ANOVA â†’ Tukey/Bonferroni.</strong> <strong>Levene's significant â†’ Welch's ANOVA â†’ Games-Howell.</strong></div>`,
    choices: [{ text: 'â†© Return and choose the right ANOVA', next: 'q4_anova' }]
  },

  q4_welch: {
    icon: 'âš¡', chapter: 'Quest IV Â· ANOVA',
    title: 'The Post-Hoc Decision',
    narrative: `<p>Welch's ANOVA across all five grand hotels:</p>
    <div class="box box-gold"><span class="box-title">ğŸ“Š Results</span><strong>F(4, 42.7) = 6.9, p = 0.0003</strong></div>
    <p>The Ivory Tower's director stands: <em>"We had the highest mean score â€” 84.2 vs 76.1 for the lowest. The ANOVA confirms we are the best hotel. Publish the rankings!"</em></p>`,
    hints: {
      formula: "Games-Howell post-hoc does not assume equal variances or equal n. Tukey HSD does. Since we used Welch's ANOVA, Games-Howell is the correct match.",
      assumption: "Mixing ANOVA type and post-hoc test (e.g. Welch's ANOVA + Tukey) violates the assumptions of the post-hoc test.",
      interpretation: "F(4, 42.7) = 6.9 means: between-hotel variance is 6.9 times the within-hotel variance â€” very unlikely if all five hotels truly perform the same."
    },
    choices: [
      { text: "The Ivory Tower has the highest mean and the F-test is significant â€” they are confirmed as the best hotel.", next: 'q4_bad_interpret', damage: 25, bad: true },
      { text: "Significant F means at least one hotel differs from at least one other â€” not which ones. We need Games-Howell post-hoc tests (matched to Welch's ANOVA) to identify specific differences.", next: 'q4_posthoc', xp: 20 }
    ]
  },

  q4_bad_interpret: {
    icon: 'ğŸ’€', chapter: 'Quest IV Â· Setback',
    title: 'The Omnibus Overreach',
    narrative: `<p>You publish the Ivory Tower as top-ranked. Games-Howell tests reveal the Ivory Tower is statistically indistinguishable from three other hotels. Lawsuits follow.</p>
    <div class="box box-danger"><span class="box-title">âš” âˆ’25 HP</span>Significant ANOVA F says: <em>"Not all hotel means are equal."</em> It does NOT tell you which pairs differ. That requires post-hoc tests. With Welch's ANOVA: use Games-Howell. With Fisher's: use Tukey or Bonferroni. Never skip the post-hoc step.</div>`,
    choices: [{ text: 'â†© Return and interpret correctly', next: 'q4_welch' }]
  },

  q4_posthoc: {
    icon: 'ğŸ—¿', chapter: 'Quest IV Â· ANOVA',
    title: 'The Omnibus Concierge',
    narrative: `<p>You have mastered the ratings war. But at the entrance to the Grand Council Hall stands the <strong>Omnibus Concierge</strong> â€” an ancient stone figure who has guarded the doors for centuries, turning away any analyst who mistakes an overall F-test for a complete answer.</p>
    <div class="box box-lore"><span class="box-title">âš” Final Boss Battle</span>The Concierge will present new hospitality scenarios across three phases. ANOVA type â†’ Levene's interpretation â†’ post-hoc logic. The clock ticks. Every wrong answer costs HP.</div>`,
    choices: [{ text: 'ğŸ—¿ Face the Omnibus Concierge', next: 'BOSS_q4', boss: true }]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOSS BATTLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOSS_BATTLES = {
  boss_q1: {
    name: 'The Ghost of Spurious Reviews',
    icon: 'ğŸ‘ï¸',
    sub: 'It manufactures false patterns in the guest ledger',
    timePerPhase: 35,
    phases: [
      {
        label: 'Identify the Test',
        narrative: `<p>The Ghost conjures a ledger: <em>"The Crowned Stag tracked average nightly spend per guest (gold coins) and overall satisfaction score (0â€“100) across 45 consecutive weekends. Management wants to know: is there a relationship between how much guests spend and how satisfied they are?"</em></p>
        <p>The Ghost whispers: <span style="color:var(--blood)">"What statistical test is appropriate for two continuous variables?"</span></p>`,
        choices: [
          { text: "Chi-Square test of independence â€” it compares observed vs expected counts across categories to detect association between two variables.", correct: false, feedback: "Chi-Square works with categorical count data, not continuous measurements. Both spend and satisfaction are measured on continuous scales, so Chi-Square is not appropriate here." },
          { text: "Pearson's correlation coefficient â€” it quantifies the strength and direction of a linear relationship between two continuous variables.", correct: true, feedback: "Correct. Two continuous variables, one relationship to quantify â€” Pearson's r is exactly the right tool. The Ghost flickers and recoils." },
          { text: "Independent samples t-test â€” it determines whether the mean of one continuous variable differs significantly between two distinct groups.", correct: false, feedback: "A t-test requires a grouping variable and a continuous outcome. Here there are no groups â€” just two continuous measurements recorded per weekend across time." },
          { text: "One-way ANOVA â€” it tests whether a continuous outcome variable differs in its mean across three or more defined groups simultaneously.", correct: false, feedback: "ANOVA requires discrete group membership. We have two continuous measurements with no grouping variable, so the question is about association, not group mean differences." }
        ]
      },
      {
        label: 'Check Assumptions',
        narrative: `<p>The scatter plot of spend vs satisfaction appears. The relationship looks roughly linear â€” a gentle upward slope across most of the data, with a few high-spending, low-satisfaction outliers.</p>
        <p><span style="color:var(--blood)">"What is the critical assumption you must verify before computing Pearson's r?"</span></p>`,
        choices: [
          { text: "That both variables are recorded in the same units of measurement, so that their scales are directly comparable when computing the correlation.", correct: false, feedback: "Pearson's r is fully scale-invariant â€” it standardises both variables internally, so matching units is irrelevant. The shape of the scatter, not the scale, is what determines whether Pearson's r is valid." },
          { text: "That the scatter plot shows an approximately linear (straight-line) relationship between the two variables, not a curve or plateau.", correct: true, feedback: "Exactly right. Pearson's r only captures linear co-variation. A curved or non-monotonic relationship can produce r â‰ˆ 0 even when a strong pattern exists. The Ghost recoils from your precision." },
          { text: "That the total sample size is large enough â€” at least 40 observations â€” to produce a reliable and stable correlation estimate.", correct: false, feedback: "Sample size governs statistical power and the width of confidence intervals, not the validity of Pearson's r itself. Even with n = 15, if the scatter is linear, Pearson's r is appropriate to compute." },
          { text: "That both variables were measured during the same time window, ensuring the data points represent matched, contemporaneous observations.", correct: false, feedback: "Temporal matching is a data collection design concern, not a statistical assumption of Pearson's r. The critical check is always the shape of the scatter â€” linear or not." }
        ]
      },
      {
        label: 'Interpret the Output',
        narrative: `<p>You run Pearson's r on spend vs satisfaction. The results:</p>
        <div class="box box-gold" style="margin:0.8rem 0"><span class="box-title">Output</span><strong>r = 0.58, p = 0.0001, 95% CI [0.34, 0.75]</strong>, n = 45</div>
        <p><span style="color:var(--blood)">"The owner sees r = 0.58 and p &lt; 0.001. She announces: 'Higher spend CAUSES higher satisfaction â€” we should push upselling harder.' What do you tell her?"</span></p>`,
        choices: [
          { text: "She is right â€” r = 0.58 is statistically significant, which confirms that increasing spend directly produces higher satisfaction scores across the guest population.", correct: false, feedback: "Statistical significance never establishes causation. The relationship could run in reverse (satisfied guests spend more freely), or both could reflect a third variable such as guest type or trip purpose." },
          { text: "r = 0.58 shows a significant moderate-to-strong association, but correlation cannot establish causation. A third variable â€” guest type, for instance â€” could drive both, so we cannot conclude upselling will raise satisfaction.", correct: true, feedback: "Perfectly stated. Strong, significant association â€” interpreted honestly, without causal overreach. The Ghost dissolves back into the ledger pages." },
          { text: "r = 0.58 means that spend directly explains 58% of the total variance observed in guest satisfaction scores across these 45 weekends.", correct: false, feedback: "r is not the variance explained â€” rÂ² is. Here rÂ² = 0.34, meaning about 34% of satisfaction variance is associated with spend. Confusing r with rÂ² is a common and consequential error." },
          { text: "p < 0.001 means there is a 99.9% probability that this is a real, meaningful effect rather than a chance finding in this sample.", correct: false, feedback: "p-values do not represent the probability of a real effect. p = 0.0001 means: if the true correlation were zero, observing r = 0.58 in a sample of 45 would be extremely unlikely â€” that is all it means." }
        ]
      }
    ]
  },

  boss_q2: {
    name: 'The Wraith of the Contingency Table',
    icon: 'ğŸ‘»',
    sub: 'It fills booking records with false associations',
    timePerPhase: 35,
    phases: [
      {
        label: 'Identify the Test',
        narrative: `<p>The Wraith conjures a scenario: <em>"A hotel surveyed 180 guests about their room type preference (Standard / Deluxe / Suite) and their booking channel (Direct website / OTA / Travel agent). Management wants to know: does booking channel predict room type preference?"</em></p>
        <p><span style="color:var(--blood)">"Both variables are categorical. What test is appropriate?"</span></p>`,
        choices: [
          { text: "Independent samples t-test â€” comparing the mean of a continuous outcome variable across two or more distinct, non-overlapping groups.", correct: false, feedback: "A t-test requires at least one continuous variable as the outcome. Both room type and booking channel are categorical â€” there is no continuous measurement to compare here." },
          { text: "Pearson's correlation â€” measuring the strength and direction of a linear relationship between two variables measured on continuous scales.", correct: false, feedback: "Pearson's r requires two continuous variables. Room type (Standard/Deluxe/Suite) and booking channel (Direct/OTA/Travel agent) are both categorical with no numeric ordering." },
          { text: "Chi-Square test of independence â€” testing whether the distribution of one categorical variable differs systematically across levels of another categorical variable.", correct: true, feedback: "Correct. Two categorical variables, testing for association â€” Chi-Square is exactly the right tool. It tests whether room type preference is independent of booking channel. The Wraith shrieks." },
          { text: "Paired t-test â€” comparing two continuous measurements taken from the same individuals under two different conditions or time points.", correct: false, feedback: "Paired t-tests require continuous data and matched observations from the same person. Neither condition holds here â€” both variables are categorical and recorded once per guest." }
        ]
      },
      {
        label: 'Check the Expected Counts',
        narrative: `<p>You calculate the 3Ã—3 contingency table's expected counts. The smallest expected count is 4.1 â€” in the Suite Ã— Travel Agent cell.</p>
        <p><span style="color:var(--blood)">"Can you proceed with Chi-Square? If not, what should you use?"</span></p>`,
        choices: [
          { text: "Yes â€” a grand total of 180 guests is large enough that the Chi-Square approximation will be reliable, regardless of individual cell sizes.", correct: false, feedback: "Overall sample size does not protect against small expected counts in individual cells. The Chi-Square approximation breaks down at the cell level â€” a single cell below 5 is enough to invalidate it." },
          { text: "No â€” an expected count of 4.1 violates the rule that all expected cell counts must be â‰¥ 5. Switch to Fisher's Exact Test, which calculates exact probabilities without this approximation.", correct: true, feedback: "Exactly right. One cell below 5 invalidates the Chi-Square approximation entirely. Fisher's Exact Test is the principled solution â€” it works correctly regardless of cell sizes. The Wraith staggers." },
          { text: "Yes â€” the â‰¥ 5 rule applies to the observed cell counts in the data, not to the expected counts calculated under the null hypothesis.", correct: false, feedback: "The rule applies specifically to EXPECTED counts, not observed ones. Expected counts (E = row total Ã— column total / grand total) represent the null hypothesis baseline â€” they must all be â‰¥ 5 for Chi-Square to be valid." },
          { text: "No â€” the correct solution is to collapse the Standard and Deluxe room categories into one combined category, which will raise the problematic cell's expected count above 5.", correct: false, feedback: "Collapsing categories is a possible workaround, but it discards potentially meaningful distinctions between room types. Fisher's Exact Test is the statistically principled solution â€” it handles small cells without any category merging." }
        ]
      },
      {
        label: 'Interpret the Output',
        narrative: `<p>Fisher's Exact Test is run on the booking channel vs room type table. Results:</p>
        <div class="box box-gold" style="margin:0.8rem 0"><span class="box-title">Output</span><strong>Fisher's Exact p = 0.042</strong></div>
        <p><span style="color:var(--blood)">"What does p = 0.042 tell management about booking channel and room type?"</span></p>`,
        choices: [
          { text: "Room type preference is significantly associated with booking channel (p &lt; 0.05) â€” the distribution of preferences differs across channels more than chance alone would produce, though the test does not specify which cells drive this.", correct: true, feedback: "Perfectly stated. The overall association is non-random. To identify which specific channel-room combinations are driving it, examine standardised residuals next. The Wraith dissolves." },
          { text: "OTA guests prefer Deluxe rooms significantly more than Direct website guests do â€” p = 0.042 identifies this specific cell pairing as the source of the overall significant result.", correct: false, feedback: "Fisher's Exact Test â€” like Chi-Square â€” is an omnibus test. It establishes overall association only. Identifying which specific cells drive the result requires standardised residuals or corrected pairwise comparisons." },
          { text: "There is a 4.2% probability that booking channel causally determines room type preference â€” meaning channel choice directly influences what guests want to book.", correct: false, feedback: "p-values express the probability of observing this data pattern if the two variables were truly independent â€” not the probability of a causal relationship. p = 0.042 says nothing about causation." },
          { text: "The result is not significant because p = 0.042 exceeds the more rigorous threshold of p &lt; 0.01 that should be applied to avoid false positives in commercial research.", correct: false, feedback: "The conventional significance threshold is Î± = 0.05 unless a stricter level was pre-specified. p = 0.042 is below 0.05, making this a statistically significant result by standard criteria." }
        ]
      }
    ]
  },

  boss_q3: {
    name: 'The Variance Hydra of the Cellar',
    icon: 'ğŸ‰',
    sub: 'Each head embodies a different t-test violation',
    timePerPhase: 40,
    phases: [
      {
        label: 'Choose the T-Test',
        narrative: `<p>The first head rears up: <em>"A luxury hotel's spa tracked guests' stress scores (0â€“100) BEFORE and AFTER a 90-minute treatment session. The same 24 guests were measured both times. Management wants to know if the treatment reduces stress."</em></p>
        <p><span style="color:var(--blood)">"Which t-test?"</span></p>`,
        choices: [
          { text: "Independent samples t-test â€” treating the before and after scores as two separate groups of measurements with no connection between them.", correct: false, feedback: "The two sets of scores are not independent â€” they come from the same 24 guests. Ignoring this within-person link discards the most important information in the data and dramatically reduces statistical power." },
          { text: "One-sample t-test â€” comparing the post-treatment scores against a known population benchmark or theoretical standard for acceptable stress levels.", correct: false, feedback: "A one-sample t-test requires a pre-existing benchmark to compare against. The research question here is about change within each person, not whether the post scores meet some external standard." },
          { text: "Paired t-test â€” using each guest's difference score (after minus before) to test whether the mean change across all 24 guests differs significantly from zero.", correct: true, feedback: "Correct. Same 24 guests measured twice â€” the paired t-test uses each person's difference score, cancelling out individual baseline variation and dramatically increasing sensitivity. First head falls." },
          { text: "Welch's t-test â€” comparing two independent groups when the variance of scores may differ between the before condition and the after condition.", correct: false, feedback: "Welch's t-test is for independent groups with potentially unequal variance. These measurements are paired â€” the same person appears in both conditions â€” so Welch's is not appropriate regardless of variance." }
        ]
      },
      {
        label: "Levene's Test in the Restaurant",
        narrative: `<p>Second head: <em>"Two restaurants in the same hotel chain â€” the Garden Room and the Rooftop Terrace â€” each had 30 different diners rate their meal experience (0â€“100). Management wants to compare the two venues. Levene's test result: F(1, 58) = 0.61, p = 0.44."</em></p>
        <p><span style="color:var(--blood)">"Which t-test and why?"</span></p>`,
        choices: [
          { text: "Welch's t-test â€” it is the safest default for any two-group comparison because it performs well whether or not the group variances are equal.", correct: false, feedback: "Welch's is a reasonable default, but with Levene's p = 0.44 there is clear evidence of equal variances. Student's t-test is slightly more powerful in this situation and its assumption is met." },
          { text: "Student's t-test â€” Levene's p = 0.44 is well above 0.05, so we fail to reject equal variances and the pooled-variance assumption is justified.", correct: true, feedback: "Correct. Levene's p = 0.44 gives no reason to doubt equal variances. Student's t-test is appropriate and marginally more powerful than Welch's when the equal variance assumption genuinely holds. Second head falls." },
          { text: "Neither t-test can be used yet â€” a significant Levene's result is a prerequisite before any t-test comparison can proceed.", correct: false, feedback: "This reverses the logic entirely. A significant Levene's result is the problem that forces you to switch from Student's to Welch's. A non-significant result, as here, is what allows Student's t-test to proceed." },
          { text: "Paired t-test â€” if diners are matched by reservation time across the two venues, the within-pair correlation will increase power and reduce noise in the comparison.", correct: false, feedback: "These are 30 entirely different diners at two separate venues. Pairing requires the same individual measured in both conditions, which is impossible here since no guest visited both restaurants for this study." }
        ]
      },
      {
        label: 'One-Tailed or Two-Tailed?',
        narrative: `<p>Third head: <em>"An independent t-test comparing front-of-house staff tips at two hotel branches gives t(58) = 1.98, p (two-tailed) = 0.052. After seeing the results, the manager says: 'Our hypothesis was always that Branch A gets higher tips â€” let's report one-tailed p = 0.026 to show significance!'"</em></p>
        <p><span style="color:var(--blood)">"Is switching to one-tailed legitimate here?"</span></p>`,
        choices: [
          { text: "Yes â€” the directional prediction that Branch A earns higher tips is clear and reasonable, making one-tailed testing scientifically justified even if confirmed after the data was examined.", correct: false, feedback: "Directional clarity does not make post-hoc one-tailed testing legitimate. The hypothesis must be committed to in writing before any data is collected or examined â€” not confirmed by looking at which way the result went." },
          { text: "Yes â€” one-tailed tests are more statistically powerful and are therefore the preferred choice when you have any reasonable expectation about the direction of the effect.", correct: false, feedback: "One-tailed tests gain power in one direction by quietly doubling the false-positive rate in that direction. Their use is only justified by a genuine, pre-registered directional hypothesis â€” not by a post-hoc preference for power." },
          { text: "No â€” the direction was chosen after seeing the data, making this p-hacking. One-tailed testing is only valid when the directional hypothesis was fully committed to before data collection began.", correct: true, feedback: "Exactly. Switching to one-tailed because the result nearly reached significance two-tailed is a textbook example of p-hacking â€” it inflates the false-positive rate while appearing methodologically reasonable. All three heads fall." },
          { text: "No â€” one-tailed testing is never statistically valid in applied hospitality or business research and should always be replaced with two-tailed tests regardless of the hypothesis.", correct: false, feedback: "One-tailed tests are valid in hospitality research when there is a documented a priori directional hypothesis â€” for instance, testing whether a new training programme can only improve, never worsen, service scores. The issue here is timing, not the method itself." }
        ]
      }
    ]
  },

  boss_q4: {
    name: 'The Omnibus Concierge',
    icon: 'ğŸ—¿',
    sub: "It guards the Council gates â€” answer its three challenges to enter",
    timePerPhase: 40,
    phases: [
      {
        label: 'Choose the ANOVA Type',
        narrative: `<p>The Concierge blocks the entrance: <em>"A regional hotel chain compared RevPAR across four properties: City Centre, Airport, Seaside, and Countryside. N = 25 guests per property. Levene's test: F(3, 96) = 4.9, p = 0.003."</em></p>
        <p><span style="color:var(--blood)">"Which ANOVA and which post-hoc test?"</span></p>`,
        choices: [
          { text: "Fisher's (standard) ANOVA â†’ Tukey HSD post-hoc: pools all group variances into one estimate, then uses Tukey's studentised range to compare all pairs.", correct: false, feedback: "Levene's p = 0.003 means unequal variances â€” Fisher's ANOVA assumes a common variance across groups, so this assumption is violated. Tukey HSD also assumes equal variance, making both choices wrong here." },
          { text: "Welch's ANOVA â†’ Games-Howell post-hoc: both adjust for unequal group variances and neither requires the pooled-variance assumption Fisher's method depends on.", correct: true, feedback: "Correct. Levene's p = 0.003 signals unequal variances across properties. Welch's ANOVA adjusts for this at the omnibus level; Games-Howell does so for every pairwise comparison. They must be used together. The door begins to open." },
          { text: "Fisher's ANOVA â†’ Games-Howell post-hoc: use the standard omnibus test for overall significance, then the variance-robust post-hoc for individual pair comparisons.", correct: false, feedback: "Games-Howell is the right post-hoc, but Fisher's ANOVA for the omnibus test still assumes equal variances â€” which Levene's has shown to be false. The overall test and post-hoc must both be variance-robust when Levene's is significant." },
          { text: "Welch's ANOVA â†’ Tukey HSD post-hoc: use the variance-robust omnibus test, then Tukey's widely-accepted range test for the pairwise comparisons that follow.", correct: false, feedback: "Welch's ANOVA is correct, but Tukey HSD assumes equal variances for its calculations. Pairing a variance-robust omnibus test with a post-hoc that assumes equal variance is internally inconsistent â€” use Games-Howell instead." }
        ]
      },
      {
        label: 'Interpret the F-Test',
        narrative: `<p>Welch's ANOVA across the four hotel properties:</p>
        <div class="box box-gold" style="margin:0.8rem 0"><span class="box-title">Output</span><strong>F(3, 46.2) = 7.1, p = 0.0005</strong></div>
        <p><span style="color:var(--blood)">"The CEO sees p = 0.0005 and announces: 'The City Centre property is confirmed as significantly better than all others â€” the ANOVA says so!' What is wrong with this?"</span></p>`,
        choices: [
          { text: "Nothing is wrong â€” p = 0.0005 is highly significant, which confirms that the City Centre's mean RevPAR is statistically distinguishable from every other property in the chain.", correct: false, feedback: "The F-test is omnibus â€” it tests whether all four means are equal, not whether one specific property differs from all others. p = 0.0005 says at least one pair differs somewhere, but identifies no specific pair." },
          { text: "The CEO is correct that City Centre is the best, since having the highest observed mean combined with a significant overall F-test logically confirms its superiority over the others.", correct: false, feedback: "A significant F combined with the highest mean does not confirm superiority. City Centre's mean could be statistically indistinguishable from Seaside, for instance â€” only post-hoc tests can reveal which specific differences are real." },
          { text: "The significant F tells us only that not all four properties perform equally â€” it does not identify which specific properties differ, which requires Games-Howell post-hoc tests.", correct: true, feedback: "Exactly right. The omnibus F controls Type I error for the family of comparisons but reveals nothing about specific pairs. Games-Howell post-hoc tests are required to map the actual structure of differences. The Concierge nods slowly." },
          { text: "The result cannot be properly interpreted because no effect size measure such as Î·Â² or Ï‰Â² was reported alongside the F-statistic and p-value.", correct: false, feedback: "Effect sizes are important for practical interpretation, but their absence doesn't make the F-test uninterpretable. The omnibus conclusion â€” at least one property differs â€” stands without them. The CEO's error is about specificity, not effect size." }
        ]
      },
      {
        label: 'Post-Hoc Pairing Logic',
        narrative: `<p>The Concierge's final challenge: <em>"A hotel group's analyst suggests running 6 separate Bonferroni-corrected t-tests instead of Games-Howell, arguing it gives more flexibility. The Director argues: just look at the means after ANOVA, no post-hoc needed. Who is right?"</em></p>
        <p><span style="color:var(--blood)">"What is the principled approach for this specific dataset?"</span></p>`,
        choices: [
          { text: "Welch's ANOVA for the omnibus test, then Games-Howell for all pairwise comparisons â€” the only workflow that respects the unequal variance structure at both the overall and individual pair level.", correct: true, feedback: "This is the complete and correct answer. Welch's ANOVA + Games-Howell is internally consistent: both handle unequal variances, and both are required when Levene's test is significant. The Concierge steps aside â€” the Council doors open." },
          { text: "Six Bonferroni-corrected t-tests, since Bonferroni is a well-established and flexible correction for multiple comparisons that controls family-wise error rate just as rigorously as Games-Howell.", correct: false, feedback: "Bonferroni-corrected t-tests assume equal variances, making them less appropriate when Levene's test is significant. Games-Howell is specifically designed for unequal variances and is the better-matched solution for this dataset." },
          { text: "No post-hoc tests are needed â€” a significant omnibus ANOVA combined with visual inspection of the group means is sufficient to identify which properties are meaningfully different from each other.", correct: false, feedback: "Visual mean differences tell you nothing about statistical reliability. Without post-hoc tests, you cannot distinguish real differences from sampling noise â€” especially with only 25 guests per property and unequal variances across groups." },
          { text: "Run the analysis with both Games-Howell and Bonferroni, then report the version whose results are more significant, since this gives the most complete picture of which pairs actually differ.", correct: false, feedback: "Choosing between methods based on which yields more significant results is a form of p-hacking. The analytical approach must be selected on methodological grounds before results are examined, not chosen to maximise significant findings." }
        ]
      }
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles() {
  for (let i = 0; i < 12; i++) {
    const p = document.createElement('div');
    p.className = 'ember-particle';
    p.style.cssText = `
      left: ${Math.random()*100}vw;
      animation-duration: ${4 + Math.random()*6}s;
      animation-delay: ${Math.random()*8}s;
      --drift: ${(Math.random()-0.5)*60}px;
      width: ${1+Math.random()*2}px;
      height: ${1+Math.random()*2}px;
    `;
    document.body.appendChild(p);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  const hud = document.getElementById('hud');
  if (!G.class) { hud.classList.remove('visible'); return; }
  hud.classList.add('visible');

  const cls = CLASSES[G.class];
  document.getElementById('hud-class-name').textContent = cls.name;

  const hpPct = Math.max(0, (G.hp / G.maxHp) * 100);
  const fill = document.getElementById('hud-hp-fill');
  fill.style.width = hpPct + '%';
  fill.style.background = hpPct > 60 ? 'var(--hp-full)' : hpPct > 30 ? 'var(--hp-mid)' : hpPct > 15 ? 'var(--hp-low)' : 'var(--hp-crit)';
  document.getElementById('hud-hp-text').textContent = `${G.hp}/${G.maxHp}`;

  const xpPct = Math.min(100, (G.xp % XP_PER_LEVEL) / XP_PER_LEVEL * 100);
  document.getElementById('hud-xp-fill').style.width = xpPct + '%';
  document.getElementById('hud-xp-text').textContent = `${G.xp} (Lv ${G.level})`;

  if (G.currentQuest) {
    const q = QUESTS[G.currentQuest];
    document.getElementById('hud-quest').textContent = `${q.chapter}: ${q.topic}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XP & LEVELLING â€” FIX: Use pendingLevelUpCallback global
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gainXP(amount, callback) {
  const oldLevel = G.level;
  G.xp += amount;
  G.level = Math.floor(G.xp / XP_PER_LEVEL) + 1;
  updateHUD();
  if (G.level > oldLevel) {
    showLevelUp(G.level, callback);
  } else {
    if (callback) callback();
  }
}

// FIX: Store callback in global variable â€” never serialize to string
function showLevelUp(level, callback) {
  pendingLevelUpCallback = callback;
  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="levelup-screen">
      <span class="levelup-icon">âœ¨</span>
      <div class="levelup-title">Level ${level}!</div>
      <p style="color:var(--text-dim); font-family:'Cinzel',serif; font-size:0.8rem; letter-spacing:0.1em; margin-bottom:1.5rem">YOUR KNOWLEDGE GROWS STRONGER</p>
      <button class="btn btn-gold" onclick="continueLevelUp()">Continue â€º</button>
    </div>`;
}

// FIX: Global function that fires the stored callback
function continueLevelUp() {
  if (pendingLevelUpCallback) {
    const cb = pendingLevelUpCallback;
    pendingLevelUpCallback = null;
    cb();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAMAGE / DEATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function takeDamage(amount) {
  G.hp = Math.max(0, G.hp - amount);
  updateHUD();

  const flash = document.createElement('div');
  flash.className = 'attack-flash';
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 500);

  document.getElementById('main-content').classList.add('shake');
  setTimeout(() => document.getElementById('main-content').classList.remove('shake'), 400);

  const dmg = document.createElement('div');
  dmg.className = 'dmg-number';
  dmg.style.cssText = `color:var(--blood); top:${window.innerHeight*0.4}px; left:${window.innerWidth*0.5-30}px;`;
  dmg.textContent = `-${amount} HP`;
  document.body.appendChild(dmg);
  setTimeout(() => dmg.remove(), 1200);

  if (G.hp <= 0) {
    setTimeout(showDeath, 600);
    return true;
  }
  return false;
}

function showDeath() {
  if (G.bossTimer) clearInterval(G.bossTimer);
  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="card">
      <div class="death-screen">
        <span class="death-icon">ğŸ’€</span>
        <div class="death-title">You Have Fallen</div>
        <div class="death-sub">The Quest Claims Another Soul</div>
        <div class="box box-danger" style="text-align:left; margin-bottom:1.5rem">
          <span class="box-title">âš” The Order's Chronicle</span>
          You fought valiantly. The monsters of statistical misunderstanding are formidable. 
          But in the Order of the Significant P, death is a teacher â€” not an ending. Your HP is restored. 
          Return to the questline and face your demons again.
        </div>
        <button class="btn btn-primary" onclick="restartQuest()">âš” Rise Again â€” Retry Quest</button>
        &nbsp;&nbsp;
        <button class="btn btn-ghost" onclick="showMap()">â†© Retreat to the Archive</button>
      </div>
    </div>`;
}

function restartQuest() {
  const cls = CLASSES[G.class];
  G.hp = cls.hp;
  if (G.currentQuest) {
    startQuest(G.currentQuest);
  } else {
    showMap();
  }
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SORTING ADVENTURE
// Each choice maps to a class: wizard=ğŸ“Š, healer=ğŸŒ¿, rogue=ğŸ—ï¸
// After 5 scenes the most-chosen class wins.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SORTING_SCENES = [
  {
    icon: 'ğŸŒ…',
    chapter: 'The Initiation Â· Scene 1 of 5',
    title: 'First Morning in the Archive',
    narrative: `<p>You arrive on your first morning at the Grand Archive. The Archive Master â€” a small woman with ink-stained fingers and an unsettling number of keys â€” drops an envelope on your desk.</p>
    <p class="npc-speech">"A hotel owner posted us three months of guest records. No covering note, no question. Just this."</p>
    <p>You sit down with the pages and a cup of tea that is already going cold. Where do you start?</p>`,
    choices: [
      { text: "Start flicking through â€” who are these guests, what was recorded, does anything seem weird or surprising? You like to get a feel for things before getting systematic.", cls: 'rogue' },
      { text: "Lay everything out and get organised first â€” what are the columns, what do the numbers actually mean, is there a pattern to how it was put together?", cls: 'wizard' },
      { text: "Check whether the records look consistent before anything else â€” same format throughout, no obvious gaps, no sign that someone changed how they wrote things down mid-way.", cls: 'healer' }
    ]
  },
  {
    icon: 'â˜•',
    chapter: 'The Initiation Â· Scene 2 of 5',
    title: 'The Breakfast Argument',
    narrative: `<p>Two senior members of the Order are bickering. Marcus waves a sheet of paper: <em>"Revenue is up 14% on last summer â€” the new spa package is clearly working."</em></p>
    <p>Priya doesn't look up from her toast. <em>"It goes up every summer, Marcus. That's just the season."</em></p>
    <p>They both look at you. The toast is getting cold.</p>`,
    choices: [
      { text: "Priya probably has a point â€” if revenue always rises in summer, one good summer doesn't prove much. You'd want to see a few years before saying anything with confidence.", cls: 'healer' },
      { text: "Could you see last year's numbers for the same period? If 14% is bigger than the usual summer bump, that's interesting. If not, it isn't. Either way, you'd rather look.", cls: 'wizard' },
      { text: "Maybe both things are true â€” the spa helps AND the season helps. The more interesting question is who's actually booking the spa and whether those guests are spending more overall.", cls: 'rogue' }
    ]
  },
  {
    icon: 'ğŸ“',
    chapter: 'The Initiation Â· Scene 3 of 5',
    title: 'The Glowing Score',
    narrative: `<p>A hotel ran a guest satisfaction survey and got 8.4 out of 10. The manager is thrilled and wants it in a press release by end of day.</p>
    <p>You notice, in the small print, that it was only sent to loyalty programme members â€” roughly one in five guests.</p>
    <p class="npc-speech">"So we can use this, right?" she asks.</p>`,
    choices: [
      { text: "Yes, but word it carefully â€” something like 'among our regular guests' rather than just 'guests.' It's still real, just specific, and being honest about that actually builds more trust.", cls: 'rogue' },
      { text: "It's tricky â€” loyalty members are probably your happiest guests almost by definition. You'd want to flag that pretty clearly before putting it in print, or it could backfire.", cls: 'healer' },
      { text: "You'd want to think about how different loyalty members actually are before deciding. If they're not much happier than average guests, 8.4 is probably fine. If they're way happier, the number is misleading.", cls: 'wizard' }
    ]
  },
  {
    icon: 'ğŸŒ§ï¸',
    chapter: 'The Initiation Â· Scene 4 of 5',
    title: 'The Terrace Theory',
    narrative: `<p>You're looking at whether a hotel's rooftop terrace cafÃ© affects guest satisfaction. The terrace is only open on sunny days â€” so all the low satisfaction scores happen to come from rainy weekends when it's shut.</p>
    <p>A junior colleague bounces over: <em>"The terrace must be the key to everything â€” look how strong the pattern is!"</em></p>`,
    choices: [
      { text: "It's a neat pattern but probably too simple â€” rainy weekends affect loads of things besides the terrace. The weather itself might just be making guests miserable regardless of what the hotel does.", cls: 'healer' },
      { text: "Worth investigating properly â€” you'd want some rainy days when the terrace was open, or sunny days when it wasn't, to really separate the two effects. Otherwise you can't tell them apart.", cls: 'wizard' },
      { text: "The terrace might matter, but there's a more interesting question â€” guests who use it probably have more positive interactions with staff too. Maybe it's less about the terrace and more about what it enables.", cls: 'rogue' }
    ]
  },
  {
    icon: 'ğŸ•¯ï¸',
    chapter: 'The Initiation Â· Scene 5 of 5',
    title: 'Gone Eleven',
    narrative: `<p>It's gone 11pm. The candles in the Archive are burning low. You've been here since breakfast.</p>
    <p>Tomorrow a hotel owner is coming to hear whether her new check-in process improved satisfaction. Your analysis says it probably did â€” but you've just noticed she rolled it out in summer, when scores are always higher anyway. You haven't had time to untangle the two effects.</p>
    <p>What do you do?</p>`,
    choices: [
      { text: "Present the positive finding, and mention at the end that the summer timing makes certainty hard â€” you'd suggest running it through a quieter season too before banking on it.", cls: 'rogue' },
      { text: "Stay up and try to account for the seasonal effect properly. It won't be perfect, but presenting something incomplete without saying so doesn't sit right with you.", cls: 'healer' },
      { text: "Write a clear note into the presentation â€” the improvement looks real, but here's exactly why you're uncertain, and here's what a proper follow-up would look like.", cls: 'wizard' }
    ]
  }
];

// Tally of class votes during sorting
let _sortingTally = { wizard: 0, healer: 0, rogue: 0 };
let _sortingStep = 0;
// Store current sorting choices by index (same pattern as scene choices)
let _sortingChoices = [];

function showTitle() {
  _sortingTally = { wizard: 0, healer: 0, rogue: 0 };
  _sortingStep = 0;

  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div id="title-screen">
      <span class="title-sigil">âš”</span>
      <h1 class="game-title">The Order of<br>the Significant P</h1>
      <p class="title-sub">A Statistics Quest</p>
    </div>
    <div class="card" style="margin-top:2rem">
      <div class="card-rune-tl">âœ¦</div>
      <div class="card-rune-br">âœ¦</div>
      <p style="font-size:clamp(0.95rem,2vw,1.1rem); line-height:1.9; margin-bottom:1.5rem">
        You are a new recruit at the <em>Order of the Significant P</em> â€” an ancient guild of analysts who bring rigour to a hospitality industry drowning in gut feelings. Across four quests you will face the real challenges of hotel management: <strong>pricing strategy, guest satisfaction, staff training, and property rankings</strong>.
      </p>
      <p style="font-size:0.95rem; color:var(--text-dim); font-style:italic; margin-bottom:1.8rem">
        But first â€” the Archive Master must determine where you belong. Answer five questions honestly. Your role will find you.
      </p>
      <div style="text-align:center">
        <button class="btn btn-primary" onclick="showSortingScene(0)">Begin the Initiation â€º</button>
      </div>
    </div>`;
}

function showSortingScene(step) {
  _sortingStep = step;
  const scene = SORTING_SCENES[step];
  _sortingChoices = scene.choices;

  const progress = step + 1;
  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="card scene-wrap">
      <div class="card-rune-tl">âœ¦</div>
      <div class="card-rune-br">âœ¦</div>
      <div class="scene-header">
        <div class="scene-icon-lg">${scene.icon}</div>
        <div>
          <div class="scene-chapter">${scene.chapter}</div>
          <div class="scene-title">${scene.title}</div>
        </div>
      </div>
      <div style="margin-bottom:1rem">
        <div style="display:flex; gap:6px; align-items:center; margin-bottom:6px">
          ${SORTING_SCENES.map((_,i) => `
            <div style="flex:1; height:4px; border-radius:2px; background:${i < progress ? 'var(--gold)' : i === step ? 'var(--ember)' : 'var(--border-bright)'}; transition:background 0.3s"></div>
          `).join('')}
        </div>
        <div style="font-family:'Cinzel',serif; font-size:0.6rem; color:var(--text-muted); letter-spacing:0.1em; text-transform:uppercase">Initiation progress</div>
      </div>
      <div class="narrative">${scene.narrative}</div>
      <div class="choices-wrap">
        <div class="choices-label">â€” How do you respond? â€”</div>
        <div class="choices">
          ${scene.choices.map((c,i) => `
            <button class="choice-btn scroll-item" style="animation-delay:${i*0.08}s" data-sort-index="${i}">
              ${c.text}
            </button>`).join('')}
        </div>
      </div>
    </div>`;

  el.querySelectorAll('[data-sort-index]').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-sort-index'), 10);
      handleSortingChoice(_sortingChoices[idx]);
    });
  });

  window.scrollTo({top:0, behavior:'smooth'});
}

function handleSortingChoice(choice) {
  _sortingTally[choice.cls]++;
  const next = _sortingStep + 1;
  if (next < SORTING_SCENES.length) {
    showSortingScene(next);
  } else {
    showSortingResult();
  }
}

function showSortingResult() {
  // Determine winning class
  const winner = Object.entries(_sortingTally).sort((a,b) => b[1]-a[1])[0][0];
  const cls = CLASSES[winner];

  const descriptions = {
    wizard: 'Your instinct is always to go deeper into the numbers. You map data structures before asking questions, flag methodology in your reports, and will rerun an analysis at midnight rather than present something technically wrong. The Order needs people who live in the details.',
    healer: 'Your first question is always about process and integrity. Before any number means anything, you check how it was collected, whether the assumptions hold, and whether the method was decided before the data was seen. The Order needs people who protect the validity of the work.',
    rogue: 'You read the human story before you read the numbers. You reframe problems, find the insight in the limitation, and know that a result only matters if the right person understands it at the right moment. The Order needs people who make data land.'
  };

  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="card scene-wrap">
      <div class="card-rune-tl">âœ¦</div>
      <div class="card-rune-br">âœ¦</div>
      <div style="text-align:center; padding: 1.5rem 0 1rem">
        <div style="font-size:4rem; margin-bottom:0.8rem; animation: pulseGlow 3s ease-in-out infinite">${cls.icon}</div>
        <div style="font-family:'Cinzel',serif; font-size:0.7rem; letter-spacing:0.2em; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.4rem">The Archive Master has spoken</div>
        <div style="font-family:'Cinzel Decorative', serif; font-size:clamp(1.2rem,4vw,1.8rem); color:var(--gold-bright); margin-bottom:0.3rem">${cls.name}</div>
        <div style="font-family:'Cinzel',serif; font-size:0.75rem; color:var(--rune-bright); letter-spacing:0.1em">â¤ ${cls.hp} HP Â· ${cls.hintLabel}</div>
      </div>
      <div class="rune-divider">âœ¦ âœ¦ âœ¦</div>
      <div class="narrative" style="margin-top:1rem">
        <p>${descriptions[winner]}</p>
        <p><em>Your hints in battle will illuminate ${winner === 'wizard' ? 'the formulae and numerical logic' : winner === 'healer' ? 'assumption checks and process integrity' : 'interpretation and practical meaning'} behind each decision.</em></p>
      </div>
      <div style="text-align:center; margin-top:1.5rem; display:flex; gap:12px; justify-content:center; flex-wrap:wrap">
        <button class="btn btn-primary" onclick="selectClass('${winner}')">Accept Your Role â€º</button>
        <button class="btn btn-ghost" onclick="showTitle()">Retake the Initiation</button>
      </div>
    </div>`;

  window.scrollTo({top:0, behavior:'smooth'});
}

function selectClass(classKey) {
  G.class = classKey;
  const cls = CLASSES[classKey];
  G.hp = cls.hp;
  G.maxHp = cls.hp;
  G.xp = 0; G.level = 1;
  G.questsDone = [];
  updateHUD();
  showMap();
}

function showMap() {
  G.currentQuest = null;
  G.currentScene = null;
  const el = document.getElementById('main-content');
  const cls = CLASSES[G.class];

  el.innerHTML = `
    <div class="card scene-wrap">
      <div class="card-rune-tl">âœ¦</div>
      <div class="card-rune-br">âœ¦</div>
      <div class="scene-header">
        <div class="scene-icon-lg">ğŸ—ºï¸</div>
        <div>
          <div class="scene-chapter">The Grand Archive</div>
          <div class="scene-title">The Kingdom of Statistica</div>
        </div>
      </div>
      <p style="font-size:1rem; line-height:1.8; color:var(--text-dim); margin-bottom:1rem">
        Four quests. Four statistical beasts lurking in the world of hospitality management. 
        Every decision must be grounded in data â€” not instinct. 
        Your role: <strong style="color:var(--rune-bright)">${cls.icon} ${cls.name}</strong>.
      </p>
      ${G.questsDone.length === 4 ? `<div class="box box-victory"><span class="box-title">ğŸ† Grand Champion â€” The Order's Finest Manager</span>All four seals earned. Total XP: <strong>${G.xp}</strong>. Level <strong>${G.level}</strong>.</div>` : ''}
      <div class="quest-map">
        ${Object.entries(QUESTS).map(([key, q]) => {
          const done = G.questsDone.includes(key);
          // FIX: Use completion-based unlock instead of XP-level gate
          const locked = isQuestLocked(key) && !done;
          return `
          <div class="quest-node ${done?'completed':''} ${locked?'locked':''}" 
               style="--node-color:rgba(232,98,26,0.12)"
               ${locked ? '' : `onclick="startQuest('${key}')"`}>
            <span class="node-icon">${q.icon}</span>
            <div class="node-chapter">${q.chapter}</div>
            <div class="node-name">${q.name}</div>
            <div class="node-desc">${q.topic}</div>
            <div class="node-level">${locked ? 'ğŸ”’ Complete previous quest first' : done ? 'âœ“ Completed' : 'âš” Available'}</div>
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top:1.5rem; text-align:center">
        <button class="btn btn-ghost" onclick="showTitle()">â†© Retake Initiation</button>
      </div>
    </div>`;
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUEST FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startQuest(questId) {
  G.currentQuest = questId;
  const cls = CLASSES[G.class];
  G.hp = cls.hp; // restore HP at quest start
  updateHUD();
  const quest = QUESTS[questId];
  showScene(quest.scenes[0]);
}

// Store current scene choices so buttons can reference by index (avoids JSON-in-HTML quoting bugs)
let _currentChoices = [];
// Store current boss choices similarly
let _currentBossChoices = [];

function showScene(sceneId) {
  G.currentScene = sceneId;

  if (sceneId.startsWith('BOSS_')) {
    const questId = sceneId.replace('BOSS_', '');
    startBoss(questId);
    return;
  }

  const scene = SCENES[sceneId];
  if (!scene) { showMap(); return; }

  const cls = CLASSES[G.class];
  const hint = scene.hints ? scene.hints[cls.hintType] : null;

  // Store choices in a module-level array â€” buttons reference by index only
  _currentChoices = scene.choices;

  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="card scene-wrap">
      <div class="card-rune-tl">âœ¦</div>
      <div class="card-rune-br">âœ¦</div>
      <div class="scene-header">
        <div class="scene-icon-lg">${scene.icon}</div>
        <div>
          <div class="scene-chapter">${scene.chapter}</div>
          <div class="scene-title">${scene.title}</div>
        </div>
      </div>
      ${hint ? `<div class="hint-box show"><span class="hint-label">${cls.hintLabel}</span>${hint}</div>` : ''}
      <div class="narrative">${scene.narrative}</div>
      <div class="choices-wrap">
        <div class="choices-label">â€” What do you do? â€”</div>
        <div class="choices">
          ${scene.choices.map((c,i) => `
            <button class="choice-btn scroll-item" style="animation-delay:${i*0.08}s"
                    data-choice-index="${i}">
              ${c.text}
            </button>`).join('')}
        </div>
      </div>
    </div>`;

  // Attach handlers via JS â€” no inline JSON, no quoting issues
  el.querySelectorAll('.choice-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-choice-index'), 10);
      handleChoice(_currentChoices[idx]);
    });
  });

  window.scrollTo({top:0, behavior:'smooth'});
}

function handleChoice(choice) {
  if (choice.boss) {
    showScene(choice.next);
    return;
  }
  if (choice.damage) {
    const dead = takeDamage(choice.damage);
    if (dead) return;
  }
  if (choice.xp) {
    gainXP(choice.xp, () => showScene(choice.next));
    return;
  }
  showScene(choice.next);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOSS BATTLE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bossData = null;

function startBoss(questId) {
  const quest = QUESTS[questId];
  const battle = BOSS_BATTLES[quest.boss];
  bossData = {
    battle,
    questId,
    phase: 0,
    bossHp: 100,
    timeLeft: battle.timePerPhase
  };
  renderBossPhase();
}

function renderBossPhase() {
  const { battle, phase, bossHp } = bossData;
  const phaseData = battle.phases[phase];

  const el = document.getElementById('main-content');
  el.innerHTML = `
    <div class="boss-arena scene-wrap">
      <div class="boss-header">
        <div class="boss-icon">${battle.icon}</div>
        <div>
          <div class="boss-name">${battle.name}</div>
          <div class="boss-sub">${battle.sub}</div>
        </div>
        <div class="boss-hp-block">
          <div class="boss-hp-label">BOSS HP</div>
          <div class="boss-hp-track">
            <div class="boss-hp-fill" id="boss-hp-fill" style="width:${bossHp}%"></div>
          </div>
        </div>
      </div>
      <div class="boss-timer-wrap">
        <div class="timer-label">Time Remaining</div>
        <div class="boss-timer" id="boss-timer">${bossData.timeLeft}</div>
        <div class="timer-label">seconds</div>
      </div>
      <div class="boss-body">
        <div class="phase-indicator">
          ${battle.phases.map((p,i) => `
            <div class="phase-dot ${i < phase ? 'done' : i === phase ? 'active' : ''}"></div>
          `).join('')}
          <span class="phase-label">Phase ${phase+1}: ${phaseData.label}</span>
        </div>
        <div class="boss-narrative">${phaseData.narrative}</div>
        <div class="boss-choices" id="boss-choices">
          ${(() => {
            const shuffled = shuffle(phaseData.choices.map((c,i)=>({...c,origIdx:i})));
            _currentBossChoices = shuffled;
            return shuffled.map((c,i) => `
              <button class="boss-choice" data-boss-choice-index="${i}">
                ${c.text}
              </button>`).join('');
          })()}
        </div>
      </div>
    </div>`;

  // Attach boss choice handlers via JS â€” avoids inline JSON quoting bugs
  el.querySelectorAll('.boss-choice').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-boss-choice-index'), 10);
      handleBossChoice(btn, _currentBossChoices[idx]);
    });
  });

  startBossTimer();
  window.scrollTo({top:0, behavior:'smooth'});
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function startBossTimer() {
  if (G.bossTimer) clearInterval(G.bossTimer);
  G.bossTimer = setInterval(() => {
    bossData.timeLeft--;
    const timerEl = document.getElementById('boss-timer');
    if (!timerEl) { clearInterval(G.bossTimer); return; }
    timerEl.textContent = bossData.timeLeft;
    if (bossData.timeLeft <= 10) timerEl.classList.add('urgent');
    if (bossData.timeLeft <= 0) {
      clearInterval(G.bossTimer);
      const dead = takeDamage(20);
      if (!dead) {
        showBossFeedback(null, false, 'â° Time ran out! The monster attacks for âˆ’20 HP. Think faster next time!', () => {
          bossData.timeLeft = bossData.battle.timePerPhase;
          renderBossPhase();
        });
      }
    }
  }, 1000);
}

function handleBossChoice(btn, choice) {
  clearInterval(G.bossTimer);
  document.querySelectorAll('.boss-choice').forEach(b => b.disabled = true);

  if (choice.correct) {
    bossData.bossHp = Math.max(0, bossData.bossHp - 34);
    const fill = document.getElementById('boss-hp-fill');
    if (fill) fill.style.width = bossData.bossHp + '%';

    const flash = document.createElement('div');
    flash.className = 'attack-flash';
    flash.style.setProperty('--flash-color', 'rgba(45,212,116,0.25)');
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 500);

    gainXP(10, () => {});

    const isLastPhase = bossData.phase >= bossData.battle.phases.length - 1;
    showBossFeedback(btn, true, choice.feedback, () => {
      if (isLastPhase) {
        bossVictory();
      } else {
        bossData.phase++;
        bossData.timeLeft = bossData.battle.timePerPhase;
        renderBossPhase();
      }
    });
  } else {
    const dead = takeDamage(20);
    showBossFeedback(btn, false, choice.feedback, () => {
      if (!dead) {
        bossData.timeLeft = bossData.battle.timePerPhase;
        renderBossPhase();
      }
    });
  }
}

function showBossFeedback(btn, correct, feedback, callback) {
  const choicesEl = document.getElementById('boss-choices');
  if (!choicesEl) { if (callback) setTimeout(callback, 1800); return; }

  const fb = document.createElement('div');
  fb.className = correct ? 'box box-victory' : 'box box-danger';
  fb.style.marginTop = '1rem';
  fb.innerHTML = `<span class="box-title">${correct ? 'âœ… Correct!' : 'âŒ Wrong!'}</span>${feedback}`;
  choicesEl.after(fb);

  setTimeout(() => { if (callback) callback(); }, 2500);
}

function bossVictory() {
  clearInterval(G.bossTimer);
  const quest = QUESTS[G.currentQuest];

  // FIX: Ensure quest is marked done BEFORE gainXP to guarantee unlock
  if (!G.questsDone.includes(G.currentQuest)) {
    G.questsDone.push(G.currentQuest);
  }
  // Give enough XP to guarantee the next level threshold is crossed
  const xpNeeded = (G.level * XP_PER_LEVEL) - G.xp;
  const xpToGrant = Math.max(40, xpNeeded > 0 ? xpNeeded : 40);
  gainXP(xpToGrant, () => showQuestComplete(quest));
}

function showQuestComplete(quest) {
  const el = document.getElementById('main-content');
  const summaries = {
    q1: `<strong>Pearson's r</strong> measures linear association between two continuous variables. Range: -1 to +1.<br>Always plot a scatter first â€” check for linearity. Curved pattern â†’ use Spearman instead.<br>p-value = probability of r this extreme if the true correlation is zero. <strong>Significant never means causal.</strong>`,
    q2: `<strong>Chi-Square</strong> tests independence between two categorical variables.<br>Expected counts: E = (row total Ã— col total) / grand total. All E â‰¥ 5 required.<br>If any E &lt; 5 â†’ Fisher's Exact Test. Significant result = association exists but doesn't specify which cells â€” examine standardised residuals for that.`,
    q3: `<strong>Paired t-test:</strong> same subjects measured twice. <strong>One-sample t-test:</strong> compare group mean to a known benchmark. <strong>Independent t-test:</strong> two completely separate groups.<br>Levene's p &lt; 0.05 â†’ use Welch's t-test (not Student's).<br>One-tailed testing: only valid with a pre-registered directional hypothesis â€” never chosen after seeing results.`,
    q4: `<strong>ANOVA</strong> compares means across 3+ groups in one test â€” preventing false positive inflation from multiple t-tests.<br>Levene's significant â†’ <strong>Welch's ANOVA â†’ Games-Howell</strong> post-hoc.<br>Levene's non-significant â†’ <strong>Fisher's ANOVA â†’ Tukey/Bonferroni</strong> post-hoc.<br>Significant F = at least one group differs. Post-hoc tests reveal which specific pairs.`
  };

  el.innerHTML = `
    <div class="card scene-wrap">
      <div class="quest-complete-banner">
        <span class="qc-icon">ğŸ†</span>
        <div class="qc-title">${quest.chapter}: ${quest.topic} â€” Completed!</div>
        <div class="qc-xp">Seal Earned Â· Next Quest Unlocked</div>
      </div>
      <div class="box box-victory" style="margin-bottom:1.5rem">
        <span class="box-title">ğŸ“œ The Seal of ${quest.topic} â€” What You Learned</span>
        ${summaries[quest.id]}
      </div>
      <div style="text-align:center; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="startQuest('${quest.id}')">âŸ³ Replay Quest</button>
        <button class="btn btn-gold" onclick="showMap()">â†© Return to Archive</button>
      </div>
    </div>`;

  window.scrollTo({top:0, behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
spawnParticles();
showTitle();
</script>
</body>
</html>
